---
title: "COMPASS_Synoptic_SEAL_Data_Analysis_Sept2022"
author: "Stephanie J. Wilson"
date: '2023-03-03'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Run notes
```{r}
Run_notes = "GWI_202209_TR_LysC_10cm was duplicated without a dilution for Vanadium NOx."
```


## Information
```{r}
#######################################################################################
####### COMPASS Synoptic 
####### Chesapeake Bay Sites
####### Data Analysis Code: Porewater Nutrients 
####### MONTH: August 2022
##############################################################################################


############################# Information ##################################
#Author: Stephanie J. Wilson
#Edited: 20220727

#Samples taken from Lysimeters & Sippers at CB Synoptic Sites
#Samples were filtered with 0.45 uM, kept on ice, frozen until analysis
#Field Protocol: 
#Samples Analyzed on a SEAL discrete auto analyzer 
#Lab Protocol: https://docs.google.com/document/d/1VaJT7Wb9AcdmM1tgsR_9ZtQ6kwcaoNmp/edit?usp=sharing&ouid=108994740386869376571&rtpof=true&sd=true
#NOx method = https://drive.google.com/file/d/1sicqBFnzVxmDd5I2_pu8s8pj7iNOAuhF/view?usp=sharing
#NH4 method = https://drive.google.com/file/d/1ENGemUEvm_rffZqv3lz9BjD0pAMX5nzu/view?usp=sharing
#PO4 method = https://drive.google.com/file/d/1m3gXDZnJoIo_QmyhvZG4HRgGShCzm9Wq/view?usp=sharing
#Units from SEAL = mg/L and converted to uMoles/L
```

## QAQC on Slopes
```{r}
library(ggplot2)
library(data.table)

#read in datafile with all the slopes 
qlog <- read.csv("Raw Data/SERC_SEAL_STDs_Log.csv")
head(qlog)

#pull out each method 
qNH3 <- qlog[qlog$Analysis %like% "NH3", ]
head(qNH3)

qPO4 <- qlog[qlog$Analysis %like% "PO4", ]
head(qPO4)

qNOx <- qlog[qlog$Analysis %like% "V-Nox", ]
head(qNOx)

########### NH3
#plot the slopes to make sure there are no crazy outliers 
slope1 <- ggplot(data=qNH3, aes(x=Date, y=Slope)) +
           #geom_line()+
            geom_point(aes(size=3)) + 
            theme_classic() + ylim(0, 5) + 
           theme(legend.position="none") + 
           ggtitle("NH3 Slopes")
  
slope1

#plot the intercepts to make sure there are no crazy outliers 
int1 <- ggplot(data=qNH3, aes(x=Date, y=Intercept)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(-0.5,0.5) + 
  theme(legend.position="none")+ 
  ggtitle("NH3 Intercepts")

int1

#plot the R2s to make sure there are no crazy outliers 
Rsq1 <- ggplot(data=qNH3, aes(x=Date, y=R2)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(0.75, 1.25) + 
  theme(legend.position="none")+ 
  ggtitle("NH3 R2s")

Rsq1

########### PO4
slope2 <- ggplot(data=qNH3, aes(x=Date, y=Slope)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(0, 5) + 
  theme(legend.position="none")+ 
  ggtitle("PO4 Slopes")

slope2

#plot the intercepts to make sure there are no crazy outliers 
int2 <- ggplot(data=qNH3, aes(x=Date, y=Intercept)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(-0.5,0.5) + 
  theme(legend.position="none")+ 
  ggtitle("PO4 Intercepts")

int2

#plot the R2s to make sure there are no crazy outliers 
Rsq2 <- ggplot(data=qNH3, aes(x=Date, y=R2)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(0.75, 1.25) + 
  theme(legend.position="none")+ 
  ggtitle("PO4 R2s")

Rsq2

########### NOx
slope3 <- ggplot(data=qNH3, aes(x=Date, y=Slope)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(0, 5) + 
  theme(legend.position="none")+ 
  ggtitle("NOx Slopes")

slope3

#plot the intercepts to make sure there are no crazy outliers 
int3 <- ggplot(data=qNH3, aes(x=Date, y=Intercept)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(-0.5,0.5) + 
  theme(legend.position="none")+ 
  ggtitle("NOx Intercepts")

int3

#plot the R2s to make sure there are no crazy outliers 
Rsq3 <- ggplot(data=qNH3, aes(x=Date, y=R2)) +
  #geom_line()+
  geom_point(aes(size=3)) + 
  theme_classic() + ylim(0.75, 1.25) + 
  theme(legend.position="none")+ 
  ggtitle("NOx R2s")

Rsq3



```

## Code Set up 
```{r}


#packages:
library(ggplot2)
library(dplyr)
library(data.table)
library(matrixStats)
library(gridExtra)
library(ggpubr)
library(grid)

```

## Ammonia & Phosphate
```{r}
#read in data 
file1 <- read.csv("Raw Data/SEAL_COMPASS_Synoptic_NH3_PO4_202209_1.csv")
#Quick look at dataframe
head(file1)
#take out only the columns that we need 
dat1 <- file1[ ,c(1,4,6,7, 9, 12, 13)]
# assigning new names to the columns of the data frame
colnames(dat1) <- c('Run_Info','Sample_Name','Conc', "Abs", "Dilution", "Units", "Test")
dat1$Run_Number <- "1"
head(dat1)


#read in data 
file2 <- read.csv("Raw Data/SEAL_COMPASS_Synoptic_NH3_PO4_202209_2.csv")
#Quick look at dataframe
head(file2)
#take out only the columns that we need 
dat2 <- file2[ ,c(1,4,6,7, 9, 12, 13)]
# assigning new names to the columns of the data frame
colnames(dat2) <- c('Run_Info','Sample_Name','Conc', "Abs", "Dilution", "Units", "Test")
dat2$Run_Number <- "2"
head(dat2)


#read in data 
file3 <- read.csv("Raw Data/SEAL_COMPASS_Synoptic_NH3_PO4_202209_3.csv")
#Quick look at dataframe
head(file3)
#take out only the columns that we need 
dat3 <- file3[ ,c(1,4,6,7, 9, 12, 13)]
# assigning new names to the columns of the data frame
colnames(dat3) <- c('Run_Info','Sample_Name','Conc', "Abs", "Dilution", "Units", "Test")
dat3$Run_Number <- "3"
head(dat3)

alldat <- rbind(dat1, dat2, dat3)

#Pull out standards 
stds <- alldat[alldat$Sample_Name %like% "Standard", ]
head(stds)


#Pull out samples 
alldat2 <- alldat[alldat$Sample_Name %like% "MSM_", ]
alldat2 <- rbind(alldat2, (alldat[alldat$Sample_Name %like% "GWI_", ]))
alldat2 <- rbind(alldat2, (alldat[alldat$Sample_Name %like% "GCrew_", ]))
head(alldat2)

alldat3 <- alldat2

```

## NOx
```{r}

#read in data 
Nfile1 <- read.csv("Raw Data/SEAL_COMPASS_Synoptic_NOx_202209_1.csv")
#Quick look at dataframe
head(Nfile1)
#take out only the columns that we need 
Ndat1 <- Nfile1[ ,c(1,4,6,7, 9, 12, 13)]
# assigning new names to the columns of the data frame
colnames(Ndat1) <- c('Run_Info','Sample_Name','Conc', "Abs", "Dilution", "Units", "Test")
Ndat1$Run_Number <- "1"
head(Ndat1)


#read in data 
Nfile2 <- read.csv("Raw Data/SEAL_COMPASS_Synoptic_NOx_202209_2.csv")
#Quick look at dataframe
head(Nfile2)
#take out only the columns that we need 
Ndat2 <- Nfile2[ ,c(1,4,6,7, 9, 12, 13)]
# assigning new names to the columns of the data frame
colnames(Ndat2) <- c('Run_Info','Sample_Name','Conc', "Abs", "Dilution", "Units", "Test")
Ndat2$Run_Number <- "2"
head(Ndat2)


#read in data 
Nfile3 <- read.csv("Raw Data/SEAL_COMPASS_Synoptic_NOx_202209_3.csv")
#Quick look at dataframe
head(Nfile3)
#take out only the columns that we need 
Ndat3 <- Nfile3[ ,c(1,4,6,7, 9, 12, 13)]
# assigning new names to the columns of the data frame
colnames(Ndat3) <- c('Run_Info','Sample_Name','Conc', "Abs", "Dilution", "Units", "Test")
Ndat3$Run_Number <- "3"
head(Ndat3)


Nalldat <- rbind(Ndat1, Ndat2, Ndat3)

#Pull out standards 
Nstds <- Nalldat[Nalldat$Sample_Name %like% "Standard", ]
head(Nstds)


#Pull out samples 
Nalldat2 <- Nalldat[Nalldat$Sample_Name %like% "MSM_", ]
Nalldat2 <- rbind(Nalldat2, (Nalldat[Nalldat$Sample_Name %like% "GWI_", ]))
Nalldat2 <- rbind(Nalldat2, (Nalldat[Nalldat$Sample_Name %like% "GCrew_", ]))
head(Nalldat2)

Nalldat3 <- Nalldat2

```


## Dilution Corrections - ensure the latest dilution is kept
```{r Dilution Corrections, echo=FALSE}

cat("Dilution Corrections")

#Calculate the concentration when accounting for the dilution factor if applicable

#checking to see if duplicate samples (mislabeled/wrongly inputted/reran)
df_duplicates <- alldat3 %>%
  filter(!if_all(everything(), is.na)) %>%  # Remove rows that are entirely NA

  # Exclude common QC sample names and standard patterns
  filter(
    !(Sample_Name %in% c(
      "Duplicate", "CCV", "CCB", "1mg/L ammonia", "DI",
      "Blank", "Auto Spike", "0.15 mg/L"
    )) &
    !startsWith(Sample_Name, "Standard ") &
    !startsWith(Sample_Name, "Nitrite ") &
    !startsWith(Sample_Name, "Nitrate ") &
    !startsWith(Sample_Name, "Abs_Chk_") &
    !startsWith(Sample_Name, "peChk_") &
    !grepl("^\\d{1,2}/\\d{1,2}/\\d{4}\\s+\\d{1,2}:\\d{2}$", Sample_Name) &  # Remove timestamp-like names
    !grepl("^\\d+$", Sample_Name) &  # Remove sample names that are just numbers
    !is.na(Sample_Name) & Sample_Name != ""  # ðŸ” Remove blank or missing names
  ) %>%
  group_by(Test, Sample_Name) %>%  # Group by test and sample
  filter(n() > 1) %>%              # Keep only those that appear more than once
  ungroup()

#pulling them out into a string and printing them out
dil_dups_string <- df_duplicates %>%
  distinct(Sample_Name) %>%
  pull(Sample_Name) %>%
  paste(collapse = ", ")

# Make sure Dilution is numeric
df_duplicates$Dilution <- as.numeric(df_duplicates$Dilution)

# Report duplicated samples
if (dil_dups_string != "") {
  message("Duplicated samples: ", dil_dups_string)

  bad_dups <- df_duplicates %>%
    group_by(Test, Sample_Name) %>%
    summarise(
      n_dups = n(),
      any_dilution = any(Dilution > 1, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    filter(!any_dilution)

  if (nrow(bad_dups) > 0) {
    cat("\nWARNING: Duplicated samples with NO dilution (possible input error):\n")
    print(bad_dups)
  } else {
    cat("\n All duplicated samples have valid dilutions. No naming issues detected.\n")
  }

} else {
  message("No duplicated samples.")
}





alldat2 <- alldat3 %>%
  arrange(row_number()) %>%
  mutate(
    Dilution = case_when(
      Dilution == "0" ~ 1.0,
      TRUE ~ as.numeric(Dilution)
    ),
    Pair_ID = ifelse(
      grepl("Duplicate", Sample_Name, ignore.case = TRUE),
      paste0(lag(Sample_Name), "_", lag(Run_Number)),  # pair only if same run
      paste0(Sample_Name, "_", Run_Number)
    ),
    Original_Name = Sample_Name
  ) %>%
  group_by(Pair_ID, Test, Run_Number) %>%  # group by Pair_ID, Test, and Run_Number
  filter(
    Dilution == ifelse(any(Dilution > 1, na.rm = TRUE), max(Dilution, na.rm = TRUE), 1)
  ) %>%
  ungroup()




```


## Dilution Corrections NOx - ensure the latest dilution is kept
```{r Dilution Corrections, echo=FALSE}

cat("Dilution Corrections")

#Calculate the concentration when accounting for the dilution factor if applicable

#checking to see if duplicate samples (mislabeled/wrongly inputted/reran)
df_duplicates <- Nalldat3 %>%
  filter(!if_all(everything(), is.na)) %>%  # Remove rows that are entirely NA

  # Exclude common QC sample names and standard patterns
  filter(
    !(Sample_Name %in% c(
      "Duplicate", "CCV", "CCB", "1mg/L ammonia", "DI",
      "Blank", "Auto Spike", "0.15 mg/L"
    )) &
    !startsWith(Sample_Name, "Standard ") &
    !startsWith(Sample_Name, "Nitrite ") &
    !startsWith(Sample_Name, "Nitrate ") &
    !startsWith(Sample_Name, "Abs_Chk_") &
    !startsWith(Sample_Name, "peChk_") &
    !grepl("^\\d{1,2}/\\d{1,2}/\\d{4}\\s+\\d{1,2}:\\d{2}$", Sample_Name) &  # Remove timestamp-like names
    !grepl("^\\d+$", Sample_Name) &  # Remove sample names that are just numbers
    !is.na(Sample_Name) & Sample_Name != ""  # ðŸ” Remove blank or missing names
  ) %>%
  group_by(Test, Sample_Name) %>%  # Group by test and sample
  filter(n() > 1) %>%              # Keep only those that appear more than once
  ungroup()

#pulling them out into a string and printing them out
dil_dups_string <- df_duplicates %>%
  distinct(Sample_Name) %>%
  pull(Sample_Name) %>%
  paste(collapse = ", ")

# Make sure Dilution is numeric
df_duplicates$Dilution <- as.numeric(df_duplicates$Dilution)

# Report duplicated samples
if (dil_dups_string != "") {
  message("Duplicated samples: ", dil_dups_string)

  bad_dups <- df_duplicates %>%
    group_by(Test, Sample_Name) %>%
    summarise(
      n_dups = n(),
      any_dilution = any(Dilution > 1, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    filter(!any_dilution)

  if (nrow(bad_dups) > 0) {
    cat("\nWARNING: Duplicated samples with NO dilution (possible input error):\n")
    print(bad_dups)
  } else {
    cat("\n All duplicated samples have valid dilutions. No naming issues detected.\n")
  }

} else {
  message("No duplicated samples.")
}





Nalldat2 <- Nalldat3 %>%
  arrange(row_number()) %>%
  mutate(
    Dilution = case_when(
      Dilution == "0" ~ 1.0,
      TRUE ~ as.numeric(Dilution)
    ),
    Pair_ID = ifelse(
      grepl("Duplicate", Sample_Name, ignore.case = TRUE),
      paste0(lag(Sample_Name), "_", lag(Run_Number)),  # pair only if same run
      paste0(Sample_Name, "_", Run_Number)
    ),
    Original_Name = Sample_Name
  ) %>%
  group_by(Pair_ID, Test, Run_Number) %>%  # group by Pair_ID, Test, and Run_Number
  filter(
    Dilution == ifelse(any(Dilution > 1, na.rm = TRUE), max(Dilution, na.rm = TRUE), 1)
  ) %>%
  ungroup()


```


## Constants 
```{r}

N_mw <- 14.0067   # molecular weight of N 

P_mw <- 30.973762  # molecular weight of P 

Con1 <- 1000       # conversion factor value

Con2 <- 1000000    # conversion factor value 

```

## Convert Data from mg/L to uM 
```{r}
head(alldat2)
head(Nalldat2)

#subset by test
NH4samples <- subset(alldat2, Test == "Ammonia 2")
head(NH4samples)

PO4samples <- subset(alldat2, Test == "o-PHOS 0.3")
head(PO4samples)

NOXsamples <- subset(Nalldat2, Test == "Vanadium NOx")
head(NOXsamples)


NH4samples$Conc_uM <- (((as.numeric(NH4samples$Conc))/Con1)/N_mw)*Con2
head(NH4samples)

PO4samples$Conc_uM <- (((as.numeric(PO4samples$Conc))/Con1)/N_mw)*Con2
head(PO4samples)

NOXsamples$Conc_uM_raw <- (((as.numeric(NOXsamples$Conc))/Con1)/N_mw)*Con2
head(NOXsamples)

#add step to make negative values equal to bd (below detection) and replace with zeros 
NOXsamples$Conc_uM <- ifelse(NOXsamples$Conc_uM_raw<0, 0, (NOXsamples$Conc_uM_raw) )
head(NOXsamples)
```

## Pull all data back together and add flags
```{r}

#pull out the columns we want from each dataframe 
NH4_pull <- NH4samples[ ,c(2,3,11) ]
head(NH4_pull)

PO4_pull <- PO4samples[ ,c(2,3,11) ]
head(PO4_pull)

NOX_pull <- NOXsamples[ ,c(2,3,12) ]
head(NOX_pull)


#Bring all this data back together: 
all_data <- merge(NH4_pull, PO4_pull, by="Sample_Name", all.x=TRUE)
all_data <- merge(all_data, NOX_pull, by="Sample_Name", all.x=TRUE)
head(all_data)

colnames(all_data) <- c("Sample_Name", "NH3_mgL", "NH3_uM", "PO4_mgL", "PO4_uM", "NOx_mgL", "NOx_uM")
head(all_data)


#add in an if then statement that tells us if they are within the range of the test - check this after doing this line
all_data$NH3_range <- ifelse(all_data$NH3_mgL<0.02, "bdl",  ifelse(all_data$NH3_mgL>2, "adl", "Within_Range")) 
all_data$PO4_range <- ifelse(all_data$PO4_mgL<0.003, "bdl",  ifelse(all_data$PO4_mgL>3, "adl", "Within_Range")) 
all_data$NOx_range <- ifelse(all_data$NOx_mgL<0.025, "bdl",  ifelse(all_data$NOx_mgL>1, "adl", "Within_Range"))
head(all_data)
```

## Take an initial look at concentrations 
```{r}
#plot data to get a sense of any outliers 
NH3look <- ggplot(data=all_data, aes(x=Sample_Name, y=NH3_uM)) +
  geom_bar(stat="identity") + 
  theme_classic() + ylim(-10, 200) + 
  theme(legend.position="none") + 
  ggtitle("Sample NH3 Concentrations")
NH3look

PO4look <- ggplot(data=all_data, aes(x=Sample_Name, y=PO4_uM)) +
  geom_bar(stat="identity") + 
  theme_classic() + ylim(-2, 50) + 
  theme(legend.position="none") + 
  ggtitle("Sample PO4 Concentrations")
PO4look

NOXlook <- ggplot(data=all_data, aes(x=Sample_Name, y=NOx_uM)) +
  geom_bar(stat="identity") + 
  theme_classic() + ylim(-2, 2) + 
  theme(legend.position="none") + 
  ggtitle("Sample NOx Concentrations")
NOXlook


```

## Pull out data you need, make IDs 
```{r}

head(all_data)

# out <- all_data[ ,c(1,3,5,7,8,9,10)]
out <- all_data
head(out)

#for steph <- pull out identifiers of the sample names 
#pull the sample ID and separate it by the underscores 
IDs <- data.frame(do.call('rbind', strsplit(as.character(out$Sample_Name),'_',fixed=TRUE)))
colnames(IDs) <- c("Site", "Date", "Zone", "Replicate", "Depth")
IDs$Month <- "September"
head(IDs)
IDs$"NA" <- NULL

#rejoin them to the dataframe
alldat <- cbind(IDs, out)
head(alldat)



```

## Export final data with flags 
```{r}

#Export Data
alldat$Run_notes = Run_notes
write.csv(alldat, file="Processed Data/COMPASS_SynopticCB_Nutrients_202209.csv")

```




