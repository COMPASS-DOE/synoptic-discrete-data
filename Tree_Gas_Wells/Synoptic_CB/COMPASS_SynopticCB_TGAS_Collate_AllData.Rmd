---
title: "COMPASS_SynopticCB_TGAS_Collate_AllData"
author: "Stephanie J. Wilson"
date: "2025-08-29"
output: pdf_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(stringr)
library(readxl)
library(tidyr)
library(tibble)
library(openxlsx)
```

## Grab 2022 and 2023 All Data Files
```{r}

#read in 2022 TGAS Data:
dat22 <- read.csv("2022/COMPASS_SynopticCB_TGAS_2022.csv")

#read in 2023 TGAS Data:
dat23 <- read.csv("2023/COMPASS_SynopticCB_TGAS_2023.csv")


```

## Add Tree Info and Clean Up
```{r}

#read in the tree information about species and dbh
tree_dat <- read.csv("COMPASS_SynopticCB_TGAS_TreeInfo.csv")
head(tree_dat)

#combine the tree data with the 2022 File 
tree_dat22 <- tree_dat %>%
  select(!"DBH_2023_cm")
dat22_wtree <- left_join(dat22, tree_dat22, by = c("Site", "Zone", "Tree_Code", "Replicate"))

dat22_wtree <- dat22_wtree %>%
  rename(DBH_cm = DBH_2022_cm)

#combine tree data with 2023 File 
tree_dat23 <- tree_dat %>%
  select(!"DBH_2022_cm")
dat23_wtree <- left_join(dat23, tree_dat23, by = c("Site", "Zone", "Tree_Code", "Replicate"))

dat23_wtree <- dat23_wtree %>%
  rename(DBH_cm = DBH_2023_cm)


#combine all the data together in one dataframe
all_dat <- rbind(dat22_wtree, dat23_wtree)

all_dat <- all_dat %>% 
  mutate(CH4_Flag = recode(CH4_Flag, "Within Std Curve Range" = "NA")) %>%
  mutate(CO2_Flag = recode(CO2_Flag, "Within Std Curve Range" = "NA")) %>%
  select("Project", "Region", "Year", "Month", "Site", "Zone", "Replicate", "Species" ,
         "DBH_cm" ,  "Status",  "Tree_Info", "Sample_ID","CH4_ppm", "CH4_Flag",  "CO2_ppm","CO2_Flag")      

```

## Make Relevant Metadata Sheet
```{r}

#pull the column names from the all_dat dataframe and create a new dataframe with them 
metadat <- data.frame(Column_Names = colnames(all_dat))

metadat$Description <- ""
metadat$Units <- ""
metadat$Instrument_ifapplicable <- ""

#add information about each line: 

metadat$Description <- c("Project Name: Project Component", 
                         "Region samples originated from: CB = Chesapeake Bay",
                         "Year (YYYY) of sample collection", 
                         "Month of sample collection",
                         "Name of sampling transect location (GCW, SWH, MSM, GWI), see dataset locations for coordinates", 
                         "Zone within space-for-time transect (UP=upland, TR=transition)",
                         "Replicate tree id (1-8)", 
                         "USDA Species code for tree sampled", 
                         "Diameter at breast height (DBH) for tree sampled in same year",
                         "Tree status indicates if the tree was Living or Dead Standing", 
                         "Tree Info indicates if the tree had sapflow monitoring during sampling, dead trees were not monitored for sapflow",
                         "Sample identifier used in laboratory and field", 
                         "Methane concentration of sample from tree gas well", 
                         "Methane concentration flag: NA (data within instrument and std curve range) or Out of Std Curve Range.", 
                         "Carbon Dioxide concentration of sample from tree gas well", 
                         "Carbon Dioxide concentration flag: NA (data within instrument and std curve range) or Out of Std Curve Range." )

metadat$Units <-      c("NA", 
                         "NA",
                         "NA", 
                         "NA",
                         "NA", 
                         "NA",
                         "NA", 
                         "NA", 
                         "cm",
                         "NA", 
                         "NA",
                         "NA", 
                         "ppm", 
                         "NA", 
                         "ppm", 
                         "NA" )

metadat$Instrument_ifapplicable <-  c("NA", 
                         "NA",
                         "NA", 
                         "NA",
                         "NA", 
                         "NA",
                         "NA", 
                         "NA", 
                         "DBH tape",
                         "NA", 
                         "NA",
                         "NA", 
                         "Varian 450 GC (Agilent Technologies)", 
                         "NA", 
                         "Varian 450 GC (Agilent Technologies)", 
                         "NA" )


```


## Write out files
```{r}

#write out a csv of all the data to the main folder: 
write.csv(all_dat, "COMPASS_SynopticCB_TGAS_AllData.csv")


#write out an excel file for ESS DIVE with the data on the first sheet and metadata on the second
wb <- createWorkbook()

# Add worksheets and write data
addWorksheet(wb, "COMPASS_SynopticCB_TGAS_Data")
writeData(wb, sheet = "COMPASS_SynopticCB_TGAS_Data", all_dat)

addWorksheet(wb, "Metadata")
writeData(wb, sheet = "Metadata", metadat)

# Save the workbook
saveWorkbook(wb, "COMPASS_SynopticCB_TGAS_AllData_forESSDIVE.xlsx", overwrite = TRUE)

```

