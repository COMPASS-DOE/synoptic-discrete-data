geom_bar(stat = 'identity') +
scale_fill_manual(values=c("darkgreen", "red"))+
#scale_fill_gradient2(low='red', mid='white', high='blue', space='Lab') +
theme_classic() + labs(x= " ", y="CO2 (ppm)", title="CO2: Green = Within Range") +
theme(legend.position="none") +
facet_grid(~Sample_Month)
ggarrange(ch4_samples, co2_samples, nrow=1, ncol=2)
#check results
head(Samples)
#pull out what we need
Samples1 <- Samples[ ,c(1:3,5:9,13, 18:21)]
head(Samples1)
Samples1 <- Samples1 %>%
separate(Sample_ID, into = c("Site", "Gas_Sample", "Zone", "Replicate"), sep = "_", remove = FALSE) %>%
mutate(Tree_Code = "SF") %>%
mutate(Tree_Info = case_when(
Tree_Code == "DS" ~ "Dead Standing",
Tree_Code == "SF" ~ "Sapflow Monitoring",
TRUE ~ "Other"  # Optional: handles any values that aren't DS or SF
)) %>%
mutate(Status = case_when(
Tree_Code == "DS" ~ "Dead Standing",
Tree_Code == "SF" ~ "Living",
TRUE ~ "Other"
)) %>%
mutate(Project = "COMPASS: Synoptic",
Region = "CB") %>%
rename( Year = Sample_Year,
Month = Sample_Month,
CH4_ppm = CH4_Conc_ppm_dilcorr ,
CO2_ppm = CO2_Conc_ppm_dilcorr )  %>%
mutate(CH4_Flag = case_when(
CH4_Flag == "Needs_Dilution" ~ "Over Std Curve Range",
TRUE ~ "Within Std Curve Range"
)) %>%
mutate(CO2_Flag = case_when(
CO2_Flag == "Needs_Dilution" ~ "Over Std Curve Range",
TRUE ~ "Within Std Curve Range"
))
final <- Samples1 %>%
select( "Project", "Region" , "Year","Month" ,"Site", "Zone", "Gas_Sample",
"Sample_ID", "Tree_Code", "Replicate", "Status", "Tree_Info",
"CH4_ppm", "CH4_Flag", "CO2_ppm", "CO2_Flag")
write.csv(final, "Processed Data/COMPASS_Synoptic_TGW_202311_Processed.csv")
#check results
head(Samples)
#pull out what we need
Samples1 <- Samples[ ,c(1:3,5:9,13, 18:21)]
head(Samples1)
Samples1 <- Samples1 %>%
separate(Sample_ID, into = c("Site", "Gas_Sample", "Zone", "Tree_Code", "Replicate"), sep = "_", remove = FALSE) %>%
mutate(Tree_Code = "SF") %>%
mutate(Tree_Info = case_when(
Tree_Code == "DS" ~ "Dead Standing",
Tree_Code == "SF" ~ "Sapflow Monitoring",
TRUE ~ "Other"  # Optional: handles any values that aren't DS or SF
)) %>%
mutate(Status = case_when(
Tree_Code == "DS" ~ "Dead Standing",
Tree_Code == "SF" ~ "Living",
TRUE ~ "Other"
)) %>%
mutate(Project = "COMPASS: Synoptic",
Region = "CB") %>%
rename( Year = Sample_Year,
Month = Sample_Month,
CH4_ppm = CH4_Conc_ppm_dilcorr ,
CO2_ppm = CO2_Conc_ppm_dilcorr )  %>%
mutate(CH4_Flag = case_when(
CH4_Flag == "Needs_Dilution" ~ "Over Std Curve Range",
TRUE ~ "Within Std Curve Range"
)) %>%
mutate(CO2_Flag = case_when(
CO2_Flag == "Needs_Dilution" ~ "Over Std Curve Range",
TRUE ~ "Within Std Curve Range"
))
final <- Samples1 %>%
select( "Project", "Region" , "Year","Month" ,"Site", "Zone", "Gas_Sample",
"Sample_ID", "Tree_Code", "Replicate", "Status", "Tree_Info",
"CH4_ppm", "CH4_Flag", "CO2_ppm", "CO2_Flag")
write.csv(final, "Processed Data/COMPASS_Synoptic_TGW_202311_Processed.csv")
library(dplyr)
library(ggplot2)
library(ggpubr)
library(stringr)
library(readxl)
library(tidyr)
library(tibble)
files <- list.files(path = "Processed Data", pattern = "\\.csv$", full.names = TRUE)
# 3. Read and combine all CSVs
all_data <- files %>%
lapply(read.csv) %>%    # or read.csv if you prefer base R
bind_rows()             # combine into one data frame
all_data <- all_data[ ,-1]
gcw_up <- read.csv("COMPASS_SynopticCB_GCW_UP_TGAS_2023.csv")
#pull out what we need
gcw_up1 <- gcw_up %>%
select( "Project", "Year","Month", "Sapflux_Tree_ID" ,
"Sample_ID","CH4_ppm", "CH4_Flag", "CO2_ppm", "CO2_Flag")
head(gcw_up1)
#clean it up and add necessary columns
gcw_up1 <- gcw_up1 %>%
mutate(Project = "COMPASS: Synoptic",
Region = "CB",
Site = "GCW",
Gas_Sample = "TGAS",
Zone = "UP",
Tree_Code = "SF") %>%
mutate(Replicate = str_extract(Sapflux_Tree_ID, "\\d+")) %>%
mutate(Tree_Info = case_when(
Tree_Code == "DS" ~ "Dead Standing",
Tree_Code == "SF" ~ "Sapflow Monitoring",
TRUE ~ "Other"  # Optional: handles any values that aren't DS or SF
)) %>%
mutate(Status = case_when(
Tree_Code == "DS" ~ "Dead Standing",
Tree_Code == "SF" ~ "Living",
TRUE ~ "Other"
)) %>%
mutate(CH4_Flag = case_when(
CH4_Flag == "Needs_Dilution" ~ "Over Std Curve Range",
TRUE ~ "Within Std Curve Range"
)) %>%
mutate(CO2_Flag = case_when(
CO2_Flag == "Needs_Dilution" ~ "Over Std Curve Range",
TRUE ~ "Within Std Curve Range"
))
#Put them in order and grab what we need
final_gcw_up <- gcw_up1 %>%
select( "Project", "Region" , "Year","Month" ,"Site", "Zone", "Gas_Sample",
"Sample_ID", "Tree_Code", "Replicate", "Status", "Tree_Info",
"CH4_ppm", "CH4_Flag", "CO2_ppm", "CO2_Flag")
#combine the TMP data with the rest of the data:
all_data_gcw <- rbind(all_data, final_gcw_up)
write.csv(all_data_gcw, "COMPASS_SynopticCB_TGAS_2023.csv")
library(dplyr)
library(ggplot2)
library(ggpubr)
library(stringr)
library(readxl)
library(tidyr)
library(tibble)
library(openxlsx)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(stringr)
library(readxl)
library(tidyr)
library(tibble)
library(openxlsx)
#read in 2022 TGAS Data:
dat22 <- read.csv("2022/COMPASS_SynopticCB_TGAS_2022.csv")
#need to deal with some of the tempest data that has the wrong replicate info
#a rep of 1 = C7
#a rep of 2 = C11
#a rep of 4 = C19
dat22$Replicate <- as.numeric(dat22$Replicate)
dat22 <- dat22 %>%
mutate(Replicate = case_when(
Site == "GCW" & Zone == "UP" & Replicate == 1 ~ 7,
Site == "GCW" & Zone == "UP" & Replicate == 2 ~ 11,
Site == "GCW" & Zone == "UP" & Replicate == 4 ~ 19,
TRUE ~ Replicate  # keep existing value otherwise
))
#read in 2023 TGAS Data:
dat23 <- read.csv("2023/COMPASS_SynopticCB_TGAS_2023.csv")
#read in the tree information about species and dbh
tree_dat <- read.csv("TGAS Tree Info/COMPASS_SynopticCB_TGAS_TreeInfo.csv")
head(tree_dat)
#combine the tree data with the 2022 File
tree_dat22 <- tree_dat %>%
select(!"DBH_2023_cm")
dat22_wtree <- left_join(dat22, tree_dat22, by = c("Site", "Zone", "Tree_Code", "Replicate"))
dat22_wtree <- dat22_wtree %>%
rename(DBH_cm = DBH_2022_cm)
#combine tree data with 2023 File
tree_dat23 <- tree_dat %>%
select(!"DBH_2022_cm")
dat23_wtree <- left_join(dat23, tree_dat23, by = c("Site", "Zone", "Tree_Code", "Replicate"))
dat23_wtree <- dat23_wtree %>%
rename(DBH_cm = DBH_2023_cm)
#read in the sampling date information
dates <- read.csv("TGAS Tree Info/COMPASS_Synoptic_TGAS_CollectionDates.csv")
head(dates)
#add sampling date and the month # to dat22
dat22_wtree_dates <- dat22_wtree %>%
left_join(dates %>% select(Site, Year, Month, Day),
by = c("Site", "Year", "Month")) %>%
mutate(Month_num = match(Month, month.name))
#add sampling date and the month # to dat23
dat23_wtree_dates <- dat23_wtree %>%
left_join(dates %>% select(Site, Year, Month, Day),
by = c("Site", "Year", "Month")) %>%
mutate(Month_num = match(Month, month.name))
#combine all the data together in one dataframe
all_dat <- rbind(dat22_wtree_dates, dat23_wtree_dates)
all_dat <- all_dat %>%
mutate(CO2_ppm = if_else(CO2_ppm < 0, 0, CO2_ppm),
CO2_ppm = round(CO2_ppm, 3)) %>%
mutate(CH4_ppm = if_else(CH4_ppm < 0, 0, CH4_ppm),
CH4_ppm = round(CH4_ppm, 3))
all_dat <- all_dat %>%
rename( Sapflux_ID = Replicate,
Month_name = Month,
Month = Month_num) %>%
mutate(CH4_Flag = recode(CH4_Flag, "Within Std Curve Range" = "NA")) %>%
mutate(CO2_Flag = recode(CO2_Flag, "Within Std Curve Range" = "NA")) %>%
select("Project", "Region", "Year", "Month", "Day", "Site", "Zone",
"Sapflux_ID", "Species",
"DBH_cm" ,  "Status",  "Tree_Info", "Sample_ID","CH4_ppm",
"CH4_Flag", "CO2_ppm","CO2_Flag")
#pull the column names from the all_dat dataframe and create a new dataframe with them
metadat <- data.frame(Column_Names = colnames(all_dat))
metadat$Description <- ""
metadat$Units <- ""
metadat$Instrument_ifapplicable <- ""
#add information about each line:
metadat$Description <- c("Project name: Project component",
"Region samples originated from: CB = Chesapeake Bay",
"Year (YYYY) of sample collection",
"Month (#) of sample collection",
"Day (#) of sample collection",
"Name of sampling transect location (GCW, SWH, MSM, GWI), see dataset locations for coordinates",
"Zone within space-for-time transect (UP=upland, TR=transition)",
"Sap flow (SF) id (1-8, 11, 19). The # ID for the sap flow sensor associated with the tree (only live trees)",
"USDA Species code for tree sampled",
"Diameter at breast height (DBH) for tree sampled in same year",
"Tree status indicates if the tree was Living or Dead Standing",
"Tree Info indicates if the tree had sap flow monitoring during sampling, dead trees were not monitored for sap flow",
"Sample identifier used in laboratory and field",
"Methane concentration of sample from tree gas well",
"Methane concentration flag: NA (data within instrument and std curve range) or Out of Std Curve Range.",
"Carbon Dioxide concentration of sample from tree gas well",
"Carbon Dioxide concentration flag: NA (data within instrument and std curve range) or Out of Std Curve Range." )
metadat$Units <-      c("NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"cm",
"NA",
"NA",
"NA",
"ppm",
"NA",
"ppm",
"NA" )
metadat$Instrument_ifapplicable <-  c("NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"NA",
"DBH tape",
"NA",
"NA",
"NA",
"Varian 450 GC (Agilent Technologies)",
"NA",
"Varian 450 GC (Agilent Technologies)",
"NA" )
#write out a csv of all the data to the main folder:
write.csv(all_dat, "COMPASS_SynopticCB_TGAS_AllData.csv")
#write out a csv of the metadata associated with the data:
write.csv(metadat, "COMPASS_SynopticCB_TGAS_Metadata.csv")
#just plot all the data
ggplot(data=all_dat, aes(x=Sapflux_ID, y=CH4_ppm, fill=Zone, color=Zone))+
geom_point()+
facet_grid(Site~Month, scales="free_y")+
theme_bw()
#Let's pull out dead trees and only plot the live ones
live_dat <- subset(all_dat, Status == "Living")
ggplot(data=live_dat, aes(x=Sapflux_ID, y=CH4_ppm, fill=Zone, color=Zone))+
geom_point()+
facet_grid(Site~Month, scales="free_y")+
theme_bw()
TGAS_avg <- live_dat %>%
group_by(Month, Site, Zone) %>%
dplyr::summarize(mean_CH4 = mean(CH4_ppm, na.rm=TRUE),
sd_CH4 = sd(CH4_ppm, na.rm=TRUE),
mean_CO2 = mean(CO2_ppm, na.rm=TRUE),
sd_CO2 = sd(CO2_ppm, na.rm=TRUE))
ggplot(data=TGAS_avg, aes(x=Month, y=mean_CH4, fill=Zone, color=Zone))+
geom_boxplot()+
facet_grid(~Site, scales="free_y")+
theme_bw()
#read in metadatfile
md <- "Raw Data/COMPASS_ChamberFlux_Metadata_2023a.csv"
metadat <- read_excel(md)
#Packages that are required
lapply(c( "fluxfinder", "readxl",
"dplyr", "ggplot2", "ggpubr", "stringr",
"purrr", "tidyverse", "here", "broom", "tibble",
"googledrive", "googlesheets4", "data.table",
"matrixStats", "gridExtra", "grid", "tidyverse", "knitr"),
library, character.only = TRUE)
#read in metadatfile
md <- "Raw Data/COMPASS_ChamberFlux_Metadata_2023a.csv"
metadat <- read_excel(md)
#read in metadatfile
md <- "Raw Data/COMPASS_ChamberFlux_Metadata_2023a.xlsx"
metadat <- read_excel(md)
#read in metadatfile
md <- "Raw Data/COMPASS_ChamberFlux_Metadata_2023.xlsx"
metadat <- read_excel(md)
#read in metadatfile
md <- "Raw Data/COMPASS_ChamberFlux_Metadata_2023.xlsx"
metadat <- read_excel(md)
#read in metadatfile
md <- "Raw Data/COMPASS_SynopticCB_TreeFlux_Metadata_2023.xlsx"
metadat <- read_excel(md)
head(metadat)
#can remove any row that have NA's in the date column
metadat <- metadat %>%
filter(!is.na(Date))
head(metadat)
#list files in raw data folder
L <- list.files(path = "Raw Data/")
head(L)
file.list <- dir(pattern = "txt$")
#Read in the data
alldat1 <- lapply(file.list, ffi_read_LI7810)
alldat <- data.table::rbindlist(alldat1, fill=TRUE)
#list files in raw data folder
L <- list.files(path = "Raw Data/", pattern = "txt$")
head(L)
#list files in raw data folder
L <- list.files(path = "Raw Data/", pattern = "txt$")
head(L)
#Read in the data
alldat1 <- lapply(L, ffi_read_LI7810)
#list files in raw data folder
L <- list.files(path = "Raw Data/", pattern = "txt$", full.names = TRUE)
head(L)
#Read in the data
alldat1 <- lapply(L, ffi_read_LI7810)
alldat <- data.table::rbindlist(alldat1, fill=TRUE)
#read in metadatfile
md <- "Raw Data/COMPASS_SynopticCB_TreeFlux_Metadata_2023.xlsx"
metadat <- read_excel(md)
head(metadat)
#can remove any row that have NA's in the date column
metadat <- metadat %>%
filter(!is.na(Date))
head(metadat)
#need to make a unique plot id that includes the date or an obs number
#read in metadatfile
md <- "Raw Data/COMPASS_SynopticCB_TreeFlux_Metadata_2023.csv"
metadat <- read.csv(md)
head(metadat)
#can remove any row that have NA's in the date column
metadat <- metadat %>%
filter(!is.na(Date))
head(metadat)
#need to make a unique plot id that includes the date or an obs number
#read in metadatfile
md <- "Raw Data/COMPASS_SynopticCB_TreeFlux_Metadata_2023.csv"
metadat <- read.csv(md)
head(metadat)
#can remove any row that have NA's in the date column
metadat <- metadat %>%
filter(!is.na(Date))
head(metadat)
#need to make a unique plot id that includes the date or an obs number
metadat$Plot <- paste0(metadat$Plot, "-", seq_len(nrow(metadat)))
head(metadat)
View(metadat)
metadat$Obs_length <- 120
head(metadat)
#read in metadata file
md <- "Raw Data/COMPASS_SynopticCB_TreeFlux_Metadata_2023.csv"
metadat <- read.csv(md)
#can remove any row that have NA's in the date column
metadat <- metadat %>%
filter(!is.na(Date))
head(metadat)
#need to make a unique plot id that includes the date or an obs number
metadat$Plot <- paste0(metadat$Plot, "-", seq_len(nrow(metadat)))
metadat$Obs_length <- 120
head(metadat)
#match the metadata to the concentration data
alldat$metadat_row <- ffi_metadata_match(
data_timestamps = alldat$TIMESTAMP,
start_dates = metadat$Date,
start_times = metadat$Time_start,
obs_lengths = metadat$Obs_length)
#read in metadata file
md <- "Raw Data/COMPASS_SynopticCB_TreeFlux_Metadata_2023.csv"
metadat <- read.csv(md)
#can remove any row that have NA's in the date column
metadat <- metadat %>%
filter(!is.na(Date))
head(metadat)
#need to make a unique plot id that includes the date or an obs number
metadat$Plot <- paste0(metadat$Plot, "-", seq_len(nrow(metadat)))
metadat$Obs_length <- 60
head(metadat)
#match the metadata to the concentration data
alldat$metadat_row <- ffi_metadata_match(
data_timestamps = alldat$TIMESTAMP,
start_dates = metadat$Date,
start_times = metadat$Time_start,
obs_lengths = metadat$Obs_length)
head(alldat)
#Set plot, temp, volume, etc. here
alldat$Plot <- metadat$Plot[alldat$metadat_row]
alldat$Volume <- metadat$Volume[alldat$metadat_row]
alldat$Temp <- metadat$Temp[alldat$metadat_row]
alldat$Site <- metadat$Site[alldat$metadat_row]
metadat$metadat_row <- seq_len(nrow(metadat))
#remove the rows that don't match to metadata
alldat <- alldat %>%
filter(!is.na(metadat_row))
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(!is.na(CH4))
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(CH4 < 0)
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(!is.na(CH4))
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(CH4 < 0)
metadat$Obs_length <- 100
#match the metadata to the concentration data
alldat$metadat_row <- ffi_metadata_match(
data_timestamps = alldat$TIMESTAMP,
start_dates = metadat$Date,
start_times = metadat$Time_start,
obs_lengths = metadat$Obs_length)
metadat$Obs_length <- 90
#match the metadata to the concentration data
alldat$metadat_row <- ffi_metadata_match(
data_timestamps = alldat$TIMESTAMP,
start_dates = metadat$Date,
start_times = metadat$Time_start,
obs_lengths = metadat$Obs_length)
head(alldat)
#Set plot, temp, volume, etc. here
alldat$Plot <- metadat$Plot[alldat$metadat_row]
alldat$Volume <- metadat$Volume[alldat$metadat_row]
alldat$Temp <- metadat$Temp[alldat$metadat_row]
alldat$Site <- metadat$Site[alldat$metadat_row]
metadat$metadat_row <- seq_len(nrow(metadat))
#remove the rows that don't match to metadata
alldat <- alldat %>%
filter(!is.na(metadat_row))
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(!is.na(CH4))
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(CH4 < 0)
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(!is.na(CH4))
#can remove any row that have NA's in the CH4 column
#alldat <- alldat %>%
# filter(CH4 < 0)
#change the units
alldat$CH4_nmol <- ffi_ppb_to_nmol(alldat$CH4,
volume = alldat$Volume, # m3
temp = alldat$Temp)    # degrees C
#> Assuming atm = 101325 Pa
#> Using R = 8.31446261815324 m3 Pa K-1 mol-1
alldat$CH4_nmol_m2 <- alldat$CH4_nmol / 0.16
fluxes <- ffi_compute_fluxes(alldat,
group_column = "Plot",
time_column = "TIMESTAMP",
gas_column = "CH4_nmol_m2",
dead_band = 10,
c0_band = 5)
#change the units
alldat$CH4_nmol <- ffi_ppb_to_nmol(alldat$CH4,
volume = alldat$Volume, # m3
temp = alldat$Temp)    # degrees C
#> Assuming atm = 101325 Pa
#> Using R = 8.31446261815324 m3 Pa K-1 mol-1
alldat$CH4_nmol_m2 <- alldat$CH4_nmol / 0.16
fluxes <- ffi_compute_fluxes(alldat,
group_column = "Plot",
time_column = "TIMESTAMP",
gas_column = "CH4_nmol_m2",
dead_band = 10)
head(fluxes)
#take a look at the fluxes we calculated with R2
ggplot(fluxes, aes(Plot, lin_flux.estimate, color = lin_r.squared)) +
geom_point(size=4) + theme_classic() +
geom_linerange(aes(ymin = lin_flux.estimate- lin_flux.std.error,
ymax = lin_flux.estimate+ lin_flux.std.error)) +
scale_color_gradientn(colours = c("darkred",  "red", "white","lightblue", "darkblue"),
values = c(0, 0.5, 0.6, 0.7, 1)) +
ylab("CH4 flux (nmol/m2/s)")
#sort fluxes by R2
fluxes_good <- as.data.frame(subset(fluxes, lin_r.squared >= .90, select = Plot:TIMESTAMP_max))
fluxes_weird <- as.data.frame(subset(fluxes, lin_r.squared < .90, select = Plot:TIMESTAMP_max))
#find fluxes that represent the first and fourth quartile of the data
low <- quantile(fluxes$lin_flux.estimate, 0.05)
high <- quantile(fluxes$lin_flux.estimate, 0.95)
fluxes_low <- as.data.frame(subset(fluxes, lin_flux.estimate <= low, select = Plot:TIMESTAMP_max))
fluxes_high <- as.data.frame(subset(fluxes, lin_flux.estimate >= high, select = Plot:TIMESTAMP_max))
tails <- rbind(fluxes_low, fluxes_high)
