#any coefficients / constants that are needed for calculations
mw_c <- 12.011   #molecular weight of Carbon
mw_n <- 14.0067  #molecular weight of Nitrogen
Con1 <- 1000       # conversion factor value
Con2 <- 1000000    # conversion factor value
#Flag that we
r2_cutoff = 0.98  #this is the level below which we want to rerun or consider a curve
chk_flag = 0.10   #for the RSD (relative standard deviation)
chk_conc_flag = 15 #this is the level cutoff for percent difference of check standards vs. the concentration they are meant to be
chks_flag = 50 #this is the percent of chks we want to have a CV less than 10, usually 60
rep_flag = 25 #this is a 25% error between samples
#blank_flag - calculated based on samples later in this code as lower 25% quantile of sample concentrations
#critical reference material concentration - Update if running different checks: ** needs update
ic_crm = 22.19
#Top standard Concentrations- Update if running different standard curve:
top_std_c = 200
#Set time zone
common_tz = "Etc/GMT+5"
Sys.setenv(TZ = "America/New_York")
#plot indicators
site_order <- c('GCW', 'MSM', 'GWI', 'SWH')
plot_order <- c('UP', 'SWAMP', 'TR', 'WC', 'SW')
plot_colors <- c("#20063B", "darkgrey", "#FFBC42", "#419973", "#25ABE6" )
cat("Assess the Check Standards")
#Pull out check standards from raw file
chks_raw <- raw_file_name %>%
map_df(read_data) %>%
filter(grepl(chks_name, sample_name)) %>% # filter to TMP samples only
bind_rows()
#we don't always the same checks so we need to pull the concentration out of the name
chks_raw <- chks_raw %>%
mutate(chk_std_conc = str_extract(sample_name, "\\d+")) %>%  # extract the number
mutate(chk_std_conc = as.numeric(chk_std_conc))    # convert to numeric
chks_raw <- chks_raw %>%
mutate(rep = row_number())
#no rsv calculated for DIC because they are all different concentrations
#calculate percent difference between check standards & expected concentration
chks_raw$C_diff <- ((chks_raw$ic_raw - chks_raw$chk_std_conc)/((chks_raw$ic_raw + chks_raw$chk_std_conc)/2)) * 100
chks_raw$C_diff_flag <-  ifelse(abs(chks_raw$C_diff) <= chk_conc_flag, 'YES', 'NO, rerun')
#Plot the check standardsvs. the expected concentration
c_chks <-  ggplot(data = chks_raw, aes(x = rep, y = ic_raw, fill=C_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkgreen", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="IC (mg/L)", title="Check Stds: IC") +
theme(legend.position="bottom")  +
guides(fill=guide_legend(title="% Difference <10%"))
c_chks
#calculate the percent of check standards that are within the range based on the flag
c_chks_percent <- (sum(chks_raw$C_diff_flag == "YES")/nrow(chks_raw))*100
#report out if flags indicate need for rerun
ifelse(c_chks_percent >= chk_flag, ">60% of IC Check Standards are within range of expected concentration",
"<60% of IC Check Standards are within range of expected concentration - REASSESS")
#write out a flag to the sample dataframe if less than 60% of the checks are within the expected CV
dat_raw$ic_flag <- ""
if (c_chks_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC checks out of range"),
"IC checks out of range"
)
}
cat("Assess Blanks")
#Pull out the blanks from raw file
blks_raw <- raw_file_name %>%
map_df(read_data) %>%
filter(grepl("DI", sample_name)) %>% # filter to TMP samples only
bind_rows()
blks_raw <- blks_raw %>%
mutate(rep = row_number())  %>%
filter(!ic_raw < 0.001) #remove DIs that weren't actually run and are completely zero
#Check if the blanks are above the lower 25% quantile of your data
blk_flag_c <- quantile(dat_raw$ic_raw, prob=c(.25))   #this gives you the lower 25% quantile of the data
blks_raw$C_diff_flag <-  ifelse(blks_raw$ic_raw <= blk_flag_c, 'YES', 'NO, rerun')
#calculate the percent of check standards that are within the range based on the flag
c_blks_percent <- (sum(blks_raw$C_diff_flag == "YES")/nrow(blks_raw))*100
#report out if flags indicate need for rerun
ifelse(c_blks_percent >= chks_flag, ">60% of Carbon Blank concentrations are lower 25% quartile of samples",
"<60% of Carbon blaks are lower 25% quartile of samples - REASSESS")
#Plot the blanks vs. the lower 25% quantile of your data in this run (black line)
c_blks <-  ggplot(data = blks_raw, aes(x = rep, y = ic_raw, fill=C_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="IC  (mg/L)", title="Blanks: IC") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_c, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
c_blks
#print out the average blank concentrations
blk_avg_c <- mean(blks_raw$ic_raw)
cat("carbon blanks:")
print(blk_avg_c)
#write out a flag to the sample dataframe if more than 60% of the blanks are above the lower 25% quantile of samples
if (c_blks_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC blanks out of range"),
"IC blanks out of range"
)
}
View(blks_raw)
cat("Assess Blanks")
#Pull out the blanks from raw file
blks_raw <- raw_file_name %>%
map_df(read_data) %>%
filter(grepl("DI", sample_name)) %>%
filter(!sample_name == "CalCurve_DIC") %>%
bind_rows()
blks_raw <- blks_raw %>%
mutate(rep = row_number())  %>%
filter(!ic_raw < 0.001) #remove DIs that weren't actually run and are completely zero
#Check if the blanks are above the lower 25% quantile of your data
blk_flag_c <- quantile(dat_raw$ic_raw, prob=c(.25))   #this gives you the lower 25% quantile of the data
blks_raw$C_diff_flag <-  ifelse(blks_raw$ic_raw <= blk_flag_c, 'YES', 'NO, rerun')
#calculate the percent of check standards that are within the range based on the flag
c_blks_percent <- (sum(blks_raw$C_diff_flag == "YES")/nrow(blks_raw))*100
#report out if flags indicate need for rerun
ifelse(c_blks_percent >= chks_flag, ">60% of Carbon Blank concentrations are lower 25% quartile of samples",
"<60% of Carbon blaks are lower 25% quartile of samples - REASSESS")
#Plot the blanks vs. the lower 25% quantile of your data in this run (black line)
c_blks <-  ggplot(data = blks_raw, aes(x = rep, y = ic_raw, fill=C_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="IC  (mg/L)", title="Blanks: IC") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_c, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
c_blks
#print out the average blank concentrations
blk_avg_c <- mean(blks_raw$ic_raw)
cat("carbon blanks:")
print(blk_avg_c)
#write out a flag to the sample dataframe if more than 60% of the blanks are above the lower 25% quantile of samples
if (c_blks_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC blanks out of range"),
"IC blanks out of range"
)
}
cat("Assess Duplicates")
#Take a look at the raw data
#head(dat_raw)
#pull out any rows that have "dup" in the sample_name column
dups <- dat_raw %>%
select(!c(ic_flag)) %>%
filter(str_detect(sample_name, "dup"))      #have to change this to match data
#create a new dataframe and remove dups from sample dataframe
dat_raw2 <- dat_raw %>%
filter(!str_detect(sample_name, "dup"))
#remove the dup from these IDs so we will have duplicate sample names
dups$sample_name<-gsub("_dup","",as.character(dups$sample_name))
dups <- dups[ ,-c(3)] #remove the run date time for
colnames(dups) <- c('sample_name', 'ic_raw_dup')
#merge with the dataframe so we have a column for the conc and the dup
QAdups <- merge(dat_raw2, dups)
#create a dataframe to compare npoc dups
df2 <- as.data.frame(QAdups$ic_raw)
df2$dups <- QAdups$ic_raw_dup
#calculate the cv of the duplicates
df2$sds <- apply(df2,1,sd)
df2$mean <- apply(df2, 1, mean)
QAdups$ic_dups_cv <- (df2$sds/df2$mean) * 100
QAdups$ic_dups_cv_flag <-  ifelse(QAdups$ic_dups_cv <10, 'YES', 'NO, rerun')
#Put all the dups together and create row numbers for plotting
QAdups <- QAdups %>%
mutate(row_num = row_number())
#head(QAdups)
#plot dups output as a bar graph to easily check - want any over 10% to be red need to work on this
C_dups <- ggplot(data =QAdups, aes(x =row_num, y =ic_dups_cv, fill=ic_dups_cv_flag)) +
geom_bar(stat = 'identity') +
theme_classic() + labs(x= " ", y="CV of IC Duplicates") +
scale_fill_manual(values = c("YES" = "darkgreen", "NO, rerun" = "red")) +
theme(legend.position="none") +  geom_hline(yintercept=10, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="CV Between Dups <10%"))
C_dups
#calculate the percent of check standards that are within the range based on the flag
c_dups_percent <- (sum(QAdups$ic_dups_cv_flag == "YES")/nrow(QAdups))*100
#report out if the dups are within range
ifelse(c_dups_percent >= chks_flag, ">60% of Carbon Duplicates have a CV <10%",
"<60% of Carbon Duplicates have a CV <10% - REASSESS")
#write out a flag to the sample dataframe if more than 60% of the dups have CVs out of range
if (c_dups_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC dups out of range"),
"IC dups out of range"
)
}
cat("Assess the Check Standards")
#Pull out check standards from raw file
chks_raw <- raw_file_name %>%
map_df(read_data) %>%
filter(grepl(chks_name, sample_name)) %>% # filter to TMP samples only
bind_rows()
#we don't always the same checks so we need to pull the concentration out of the name
chks_raw <- chks_raw %>%
mutate(chk_std_conc = str_extract(sample_name, "\\d+")) %>%  # extract the number
mutate(chk_std_conc = as.numeric(chk_std_conc))    # convert to numeric
chks_raw <- chks_raw %>%
mutate(rep = row_number())
#no rsv calculated for DIC because they are all different concentrations
#calculate percent difference between check standards & expected concentration
chks_raw$C_diff <- ((chks_raw$ic_raw - chks_raw$chk_std_conc)/((chks_raw$ic_raw + chks_raw$chk_std_conc)/2)) * 100
chks_raw$C_diff_flag <-  ifelse(abs(chks_raw$C_diff) <= chk_conc_flag, 'YES', 'NO, rerun')
#Plot the check standardsvs. the expected concentration
c_chks <-  ggplot(data = chks_raw, aes(x = rep, y = ic_raw, fill=C_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkgreen", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="IC (mg/L)", title="Check Stds: IC") +
theme(legend.position="bottom")  +
guides(fill=guide_legend(title="% Difference <10%"))
c_chks
#calculate the percent of check standards that are within the range based on the flag
c_chks_percent <- (sum(chks_raw$C_diff_flag == "YES")/nrow(chks_raw))*100
#report out if flags indicate need for rerun
ifelse(c_chks_percent >= chk_flag, ">60% of IC Check Standards are within range of expected concentration",
"<60% of IC Check Standards are within range of expected concentration - REASSESS")
#write out a flag to the sample dataframe if less than 60% of the checks are within the expected CV
if (c_chks_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC checks out of range"),
"IC checks out of range"
)
}
cat("Assess Blanks")
#Pull out the blanks from raw file
blks_raw <- raw_file_name %>%
map_df(read_data) %>%
filter(grepl("DI", sample_name)) %>%
filter(!sample_name == "CalCurve_DIC") %>%
bind_rows()
blks_raw <- blks_raw %>%
mutate(rep = row_number())  %>%
filter(!ic_raw < 0.001) #remove DIs that weren't actually run and are completely zero
#Check if the blanks are above the lower 25% quantile of your data
blk_flag_c <- quantile(dat_raw$ic_raw, prob=c(.25))   #this gives you the lower 25% quantile of the data
blks_raw$C_diff_flag <-  ifelse(blks_raw$ic_raw <= blk_flag_c, 'YES', 'NO, rerun')
#calculate the percent of check standards that are within the range based on the flag
c_blks_percent <- (sum(blks_raw$C_diff_flag == "YES")/nrow(blks_raw))*100
#report out if flags indicate need for rerun
ifelse(c_blks_percent >= chks_flag, ">60% of Carbon Blank concentrations are lower 25% quartile of samples",
"<60% of Carbon blaks are lower 25% quartile of samples - REASSESS")
#Plot the blanks vs. the lower 25% quantile of your data in this run (black line)
c_blks <-  ggplot(data = blks_raw, aes(x = rep, y = ic_raw, fill=C_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="IC  (mg/L)", title="Blanks: IC") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_c, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
c_blks
#print out the average blank concentrations
blk_avg_c <- mean(blks_raw$ic_raw)
cat("carbon blanks:")
print(blk_avg_c)
#write out a flag to the sample dataframe if more than 60% of the blanks are above the lower 25% quantile of samples
if (c_blks_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC blanks out of range"),
"IC blanks out of range"
)
}
cat("Assess Duplicates")
#Take a look at the raw data
#head(dat_raw)
#pull out any rows that have "dup" in the sample_name column
dups <- dat_raw %>%
select(!c(ic_flag)) %>%
filter(str_detect(sample_name, "dup"))      #have to change this to match data
#create a new dataframe and remove dups from sample dataframe
dat_raw2 <- dat_raw %>%
filter(!str_detect(sample_name, "dup"))
#remove the dup from these IDs so we will have duplicate sample names
dups$sample_name<-gsub("_dup","",as.character(dups$sample_name))
dups <- dups[ ,-c(3)] #remove the run date time for
colnames(dups) <- c('sample_name', 'ic_raw_dup')
#merge with the dataframe so we have a column for the conc and the dup
QAdups <- merge(dat_raw2, dups)
#create a dataframe to compare npoc dups
df2 <- as.data.frame(QAdups$ic_raw)
df2$dups <- QAdups$ic_raw_dup
#calculate the cv of the duplicates
df2$sds <- apply(df2,1,sd)
df2$mean <- apply(df2, 1, mean)
QAdups$ic_dups_cv <- (df2$sds/df2$mean) * 100
QAdups$ic_dups_cv_flag <-  ifelse(QAdups$ic_dups_cv <10, 'YES', 'NO, rerun')
#Put all the dups together and create row numbers for plotting
QAdups <- QAdups %>%
mutate(row_num = row_number())
#head(QAdups)
#plot dups output as a bar graph to easily check - want any over 10% to be red need to work on this
C_dups <- ggplot(data =QAdups, aes(x =row_num, y =ic_dups_cv, fill=ic_dups_cv_flag)) +
geom_bar(stat = 'identity') +
theme_classic() + labs(x= " ", y="CV of IC Duplicates") +
scale_fill_manual(values = c("YES" = "darkgreen", "NO, rerun" = "red")) +
theme(legend.position="none") +  geom_hline(yintercept=10, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="CV Between Dups <10%"))
C_dups
#calculate the percent of check standards that are within the range based on the flag
c_dups_percent <- (sum(QAdups$ic_dups_cv_flag == "YES")/nrow(QAdups))*100
#report out if the dups are within range
ifelse(c_dups_percent >= chks_flag, ">60% of Carbon Duplicates have a CV <10%",
"<60% of Carbon Duplicates have a CV <10% - REASSESS")
#write out a flag to the sample dataframe if more than 60% of the dups have CVs out of range
if (c_dups_percent <= chks_flag) {
dat_raw$ic_flag <- ifelse(
dat_raw$ic_flag != "",
paste0(dat_raw$ic_flag, "; IC dups out of range"),
"IC dups out of range"
)
}
cat("Sample Flagging")
#Flagging data if the concentration is outside the standards range and based on blanks
dat_flagged <- dat_raw %>%
mutate(
ic_flag = if_else(
ic_raw > top_std_c,
if_else(
ic_flag != "" & !is.na(ic_flag),
paste0(ic_flag, "; value above cal curve"),
"value above cal curve"
),
ic_flag
),
ic_flag = if_else(
blk_avg_c > 0.25 * ic_raw,
if_else(
ic_flag != "" & !is.na(ic_flag),
paste0(ic_flag, "; blank is ≥ 25% of sample value"),
"blank is ≥ 25% of sample value"
),
ic_flag
)
)
#lets make a dataframe with just the concentration flag for plotting
dat_flag_viz <- dat_raw %>%
mutate(ic_flag = case_when(ic_raw > top_std_c ~ "value above cal curve",
blk_avg_c > 0.25*ic_raw ~ "blank is ≥ 25% of sample value")
)
#Plot data and change colors based on flags to check it:
c_samples_flag <-  ggplot(data = dat_flag_viz, aes(x = sample_name, y = ic_raw, fill=ic_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values=c("red", "orange"))+
theme_classic() + labs(x= " ", y="IC (mg/L)", title="C: Grey = Within Range of Curve") +
theme(legend.position="bottom")  +
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
c_samples_flag
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(dat_flagged$sample_name),'_',fixed=TRUE)))
colnames(IDs) <- c("Date" , "Site_Code","Zone", "Lysimeter", "Depth", "Excess_Info")
#head(IDs)
#rejoin them to the dataframe
dat_flagged_id <- cbind(IDs, dat_flagged)
#Order by Zone from Upland to Surface Water
dat_flagged_id$Zone = factor(dat_flagged_id$Zone, levels = c("UP",  "SWAMP", "TR", "WC", "SW"))
dat_flagged_id <- dat_flagged_id[order(dat_flagged_id$Zone), ]
#group the data for plotting
dat_flagged_id <- dat_flagged_id %>%
group_by(Site_Code) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
mutate(sample_name = factor(sample_name,
levels = sample_name[order(Zone)])) %>%  # create row_num as factor per group
ungroup()
#Plot data and change colors based on flags to check it:
viz_c_plot <- ggplot(dat_flagged_id, aes(x = sample_name, y = ic_raw, fill = Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single")) +
facet_grid(~ Site_Code, scales="free_x") +
scale_fill_manual(values = c(
"UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6"
)) +
theme_classic() +
labs(x = " ", y = "IC (mg/L)", title = "Samples: DIC") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
print(viz_c_plot)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(dat_flagged$sample_name),'_',fixed=TRUE)))
colnames(IDs) <- c("Date" , "Site_Code","Zone", "Lysimeter", "Depth", "Excess_Info")
#head(IDs)
#rejoin them to the dataframe
dat_flagged_id <- cbind(IDs, dat_flagged)
#Order by Zone from Upland to Surface Water
dat_flagged_id$Zone = factor(dat_flagged_id$Zone, levels = c("UPCON",  "UPLAND", "TR", "WC", "SW"))
dat_flagged_id <- dat_flagged_id[order(dat_flagged_id$Zone), ]
#group the data for plotting
dat_flagged_id <- dat_flagged_id %>%
group_by(Site_Code) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
mutate(sample_name = factor(sample_name,
levels = sample_name[order(Zone)])) %>%  # create row_num as factor per group
ungroup()
#Plot data and change colors based on flags to check it:
viz_c_plot <- ggplot(dat_flagged_id, aes(x = sample_name, y = ic_raw, fill = Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single")) +
facet_grid(~ Site_Code, scales="free_x") +
scale_fill_manual(values = c(
"UPCON" = "#20063B",
"TR" = "#FFBC42",
"UPLAND" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6"
)) +
theme_classic() +
labs(x = " ", y = "IC (mg/L)", title = "Samples: DIC") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
print(viz_c_plot)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(dat_flagged$sample_name),'_',fixed=TRUE)))
colnames(IDs) <- c("Date" , "Site_Code","Zone", "Lysimeter", "Depth", "Excess_Info")
#head(IDs)
#rejoin them to the dataframe
dat_flagged_id <- cbind(IDs, dat_flagged)
#Order by Zone from Upland to Surface Water
dat_flagged_id$Zone = factor(dat_flagged_id$Zone, levels = c("UPCON",  "UPLAND", "TR", "WC", "SW"))
dat_flagged_id <- dat_flagged_id[order(dat_flagged_id$Zone), ]
#group the data for plotting
dat_flagged_id <- dat_flagged_id %>%
group_by(Site_Code) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
mutate(sample_name = factor(sample_name,
levels = sample_name[order(Zone)])) %>%  # create row_num as factor per group
ungroup()
#Plot data and change colors based on flags to check it:
viz_c_plot <- ggplot(dat_flagged_id, aes(x = sample_name, y = ic_raw, fill = Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single")) +
facet_grid(~ Site_Code, scales="free_x") +
scale_fill_manual(values = c(
"UPCON" = "#20063B",
"UPLAND" = "darkgrey",
"TR" = "#FFBC42",
"WC" = "#419973",
"SW" = "#25ABE6"
)) +
theme_classic() +
labs(x = " ", y = "IC (mg/L)", title = "Samples: DIC") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
print(viz_c_plot)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(dat_flagged$sample_name),'_',fixed=TRUE)))
colnames(IDs) <- c("Date" , "Site_Code","Zone", "Lysimeter", "Depth", "Excess_Info")
#head(IDs)
#rejoin them to the dataframe
dat_flagged_id <- cbind(IDs, dat_flagged)
#Order by Zone from Upland to Surface Water
dat_flagged_id$Zone = factor(dat_flagged_id$Zone, levels = c("UPCON",  "UP", "TR", "WC", "SW"))
dat_flagged_id <- dat_flagged_id[order(dat_flagged_id$Zone), ]
#group the data for plotting
dat_flagged_id <- dat_flagged_id %>%
group_by(Site_Code) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
mutate(sample_name = factor(sample_name,
levels = sample_name[order(Zone)])) %>%  # create row_num as factor per group
ungroup()
#Plot data and change colors based on flags to check it:
viz_c_plot <- ggplot(dat_flagged_id, aes(x = sample_name, y = ic_raw, fill = Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single")) +
facet_grid(~ Site_Code, scales="free_x") +
scale_fill_manual(values = c(
"UP" = "#20063B",
"UPCON" = "darkgrey",
"TR" = "#FFBC42",
"WC" = "#419973",
"SW" = "#25ABE6"
)) +
theme_classic() +
labs(x = " ", y = "IC (mg/L)", title = "Samples: DIC") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
print(viz_c_plot)
#convert npoc and tdn from mg/L to uMoles/L
dat_flagged_id <- dat_flagged_id %>%
mutate(
ic_uM = (((as.numeric(dat_flagged_id$ic_raw))/Con1)/mw_c)*Con2
)
cat("Check Sample IDs with Metadata")
#remove duplicates from the sample dataframe bc we are just taking the first dup run
all_data_flagged <- dat_flagged_id %>%
filter(!str_detect(sample_name, "dup")) %>%
select(!Excess_Info)
#check to see if all samples are present in the metadata
all_present <- all(all_data_flagged$sample_name %in% dic_metadata$DIC_ID)
if (all_present) {
message("All sample IDs are present in metadata.")
} else {
message("Some sample IDs are missing from metadata.")
# Optional: Which ones are missing?
missing_ids <- setdiff(all_data_flagged$sample_name, dic_metadata$DIC_ID)
print(missing_ids)
}
dic_metadata_selected <- dic_metadata %>%
select(DIC_ID, Year, Month, Day, Depth_cm, Lysimeter, Time..24hr., Time.Zone_EDT.EST,  Field.Notes)
#merge metadata with sample run data
merged_data <- all_data_flagged %>%
left_join(dic_metadata_selected, by = c("sample_name" = "DIC_ID"))
