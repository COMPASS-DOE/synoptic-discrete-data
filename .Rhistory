linetype="dashed", color = "black", linewidth=1) +
guides(fill=guide_legend(title="% Difference <10%"))
NH3_chks_plot <-  ggplot(data = NH3_chks, aes(x = rep, y = Conc, fill=NH3_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkgreen", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NH3  (mg/L)", title="Check Stds: NH3") +
theme(legend.position="bottom") +  geom_hline(yintercept=NH3_CCV,
linetype="dashed",  color = "black", linewidth=1) +
guides(fill=guide_legend(title="% Difference <10%"))
PO4_chks_plot <-  ggplot(data = PO4_chks, aes(x = rep, y = Conc, fill=PO4_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkgreen", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="PO4  (mg/L)", title="Check Stds: PO4") +
theme(legend.position="bottom") +  geom_hline(yintercept=PO4_CCV,
linetype="dashed",  color = "black", linewidth=1) +
guides(fill=guide_legend(title="% Difference <10%"))
ggarrange(NOx_chks_plot, NH3_chks_plot,NH3_chks_plot, nrow=1, ncol=3)
#calculate the percent of check standards that are within the range based on the flag
NOx_chks_percent <- (sum(NOx_chks$NOx_diff_flag == "YES")/nrow(NOx_chks))*100
NH3_chks_percent <- (sum(NH3_chks$NH3_diff_flag == "YES")/nrow(NH3_chks))*100
PO4_chks_percent <- (sum(PO4_chks$PO4_diff_flag == "YES")/nrow(PO4_chks))*100
#report out if flags indicate need for rerun
ifelse(NOx_chks_percent >= 60, ">60% of NOx Check Standards are within range of expected concentration",
"<60% of NOx Check Standards are within range of expected concentration - REASSESS")
ifelse(NH3_chks_percent >= 60,">60% of NH3 Check Standards are within range of expected concentration",
"<60% of NH3 Check Standards are within range of expected concentration - REASSESS")
ifelse(PO4_chks_percent >= 60,">60% of PO4 Check Standards are within range of expected concentration",
"<60% of PO4 Check Standards are within range of expected concentration - REASSESS")
View(samples)
cat("Assess Blanks")
#Pull out check standards from raw file
NOx_blks <- df_all %>%
filter(str_detect(Sample_Name, "CCB"))%>%
mutate(rep = row_number())
NH3_chks <- df_all %>%
filter(Test == "Ammonia 2")%>%
filter(str_detect(Sample_Name, "Blank"))%>%
mutate(rep = row_number())
PO4_chks <- df_all %>%
filter(Test == "o-PHOS 0.3")%>%
filter(str_detect(Sample_Name, "Blank"))%>%
mutate(rep = row_number())
#I think we want to check that the blank concentrations are less than the lowest 25% of sample concentrations:
blk_flag_NOx <- samples %>%
filter(Test == "Vanadium NOx") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
NOx_blks$NOx_diff_flag <-  ifelse(NOx_blks$Conc <= blk_flag_NOx, 'YES', 'NO, rerun')
blk_flag_NH3 <- samples %>%
filter(Test == "Ammonia 2") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
NH3_chks$NH3_diff_flag <-  ifelse(NH3_chks$Conc <= blk_flag_NH3, 'YES', 'NO, rerun')
blk_flag_PO4 <- samples %>%
filter(Test == "o-PHOS 0.3") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
PO4_chks$PO4_diff_flag <-  ifelse(PO4_chks$Conc <= blk_flag_PO4, 'YES', 'NO, rerun')
#calculate the percent of check standards that are within the range based on the flag
NOx_blks_percent <- (sum(NOx_blks$NOx_diff_flag == "YES")/nrow(NOx_blks))*100
NH3_blks_percent <- (sum(NH3_chks$NH3_diff_flag == "YES")/nrow(NH3_chks))*100
PO4_blks_percent <- (sum(PO4_chks$PO4_diff_flag == "YES")/nrow(PO4_chks))*100
#report out if flags indicate need for rerun
ifelse(NOx_blks_percent >= 60, ">60% of NOx Blank concentrations are lower 25% quartile of samples",
"<60% of NOx blaks are lower 25% quartile of samples - REASSESS")
ifelse(NH3_blks_percent >= 60, ">60% of NH3 Blank concentrations are lower 25% quartile of samples",
"<60% of NH3 blaks are lower 25% quartile of samples - REASSESS")
ifelse(PO4_blks_percent >= 60, ">60% of PO4 Blank concentrations are lower 25% quartile of samples",
"<60% of PO4 blaks are lower 25% quartile of samples - REASSESS")
#now plot the DOC concentrations and the TDN concentrations vs. the expected concentration
#then also make the color the percent difference between the expected and observed concentration
NOx_blks_plot <-  ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NPOC  (mg/L)", title="Check Stds: NPOC") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_NOx, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
NH3_blks_plot <-  ggplot(data = NH3_chks, aes(x = rep, y = Conc, fill=NH3_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="TN  (mg/L)", title="Check Stds: TN") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_NH3, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
PO4_blks_plot <-  ggplot(data = PO4_chks, aes(x = rep, y = Conc, fill=PO4_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="TN  (mg/L)", title="Check Stds: TN") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_PO4, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
ggarrange(NOx_blks_plot, NH3_blks_plot,PO4_blks_plot, nrow=1, ncol=3)
NOx_blks_plot
View(NOx_chks)
View(NOx_blks)
ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag))
ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity')
ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey"))
ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NPOC  (mg/L)", title="Check Stds: NPOC") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_NOx, linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
blk_flag_NOx
ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NPOC  (mg/L)", title="Check Stds: NPOC") +
theme(legend.position="bottom") +  geom_hline(yintercept=blk_flag_NOx, linetype="dashed",
color = "black", linewidth=1)
ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NPOC  (mg/L)", title="Check Stds: NPOC") +
theme(legend.position="bottom") +  geom_hline(yintercept= as.numeric(blk_flag_NOx), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
cat("Assess Blanks")
#Pull out check standards from raw file
NOx_blks <- df_all %>%
filter(str_detect(Sample_Name, "CCB"))%>%
mutate(rep = row_number())
NH3_chks <- df_all %>%
filter(Test == "Ammonia 2")%>%
filter(str_detect(Sample_Name, "Blank"))%>%
mutate(rep = row_number())
PO4_chks <- df_all %>%
filter(Test == "o-PHOS 0.3")%>%
filter(str_detect(Sample_Name, "Blank"))%>%
mutate(rep = row_number())
#I think we want to check that the blank concentrations are less than the lowest 25% of sample concentrations:
blk_flag_NOx <- samples %>%
filter(Test == "Vanadium NOx") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
NOx_blks$NOx_diff_flag <-  ifelse(NOx_blks$Conc <= blk_flag_NOx, 'YES', 'NO, rerun')
blk_flag_NH3 <- samples %>%
filter(Test == "Ammonia 2") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
NH3_chks$NH3_diff_flag <-  ifelse(NH3_chks$Conc <= blk_flag_NH3, 'YES', 'NO, rerun')
blk_flag_PO4 <- samples %>%
filter(Test == "o-PHOS 0.3") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
PO4_chks$PO4_diff_flag <-  ifelse(PO4_chks$Conc <= blk_flag_PO4, 'YES', 'NO, rerun')
#calculate the percent of check standards that are within the range based on the flag
NOx_blks_percent <- (sum(NOx_blks$NOx_diff_flag == "YES")/nrow(NOx_blks))*100
NH3_blks_percent <- (sum(NH3_chks$NH3_diff_flag == "YES")/nrow(NH3_chks))*100
PO4_blks_percent <- (sum(PO4_chks$PO4_diff_flag == "YES")/nrow(PO4_chks))*100
#report out if flags indicate need for rerun
ifelse(NOx_blks_percent >= 60, ">60% of NOx Blank concentrations are lower 25% quartile of samples",
"<60% of NOx blaks are lower 25% quartile of samples - REASSESS")
ifelse(NH3_blks_percent >= 60, ">60% of NH3 Blank concentrations are lower 25% quartile of samples",
"<60% of NH3 blaks are lower 25% quartile of samples - REASSESS")
ifelse(PO4_blks_percent >= 60, ">60% of PO4 Blank concentrations are lower 25% quartile of samples",
"<60% of PO4 blaks are lower 25% quartile of samples - REASSESS")
#now plot the DOC concentrations and the TDN concentrations vs. the expected concentration
#then also make the color the percent difference between the expected and observed concentration
NOx_blks_plot <-  ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NPOC  (mg/L)", title="Check Stds: NPOC") +
theme(legend.position="bottom") +  geom_hline(yintercept= as.numeric(blk_flag_NOx), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
NH3_blks_plot <-  ggplot(data = NH3_chks, aes(x = rep, y = Conc, fill=NH3_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="TN  (mg/L)", title="Check Stds: TN") +
theme(legend.position="bottom") +  geom_hline(yintercept=as.numeric(blk_flag_NH3), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
PO4_blks_plot <-  ggplot(data = PO4_chks, aes(x = rep, y = Conc, fill=PO4_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="TN  (mg/L)", title="Check Stds: TN") +
theme(legend.position="bottom") +  geom_hline(yintercept=as.numeric(blk_flag_PO4), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
ggarrange(NOx_blks_plot, NH3_blks_plot,PO4_blks_plot, nrow=1, ncol=3)
#find average of run carbon and nitrogen blanks for flagging samples later
blk_avg_NOx <- mean(NOx_blks$Conc)
cat("NOx blanks:")
print(blk_avg_NOx)
blk_avg_NH3 <- mean(NH3_chks$Conc)
cat("NH3 blanks:")
print(blk_flag_NH3)
blk_avg_PO4 <- mean(PO4_chks$Conc)
cat("PO4 blanks:")
print(blk_flag_PO4)
cat("Dilution Corrections")
#Calculate the concentration when accounting for the dilution factor if applicable
samples_flagged_dilcorr <- samples %>%
mutate(Conc_dilcorr = Conc * Dilution,
Conc_uM_dilcor = Conc_uM * Dilution)
View(samples_flagged_dilcorr)
cat("Dilution Corrections")
#Calculate the concentration when accounting for the dilution factor if applicable
samples_flagged_dilcorr <- samples %>%
mutate(`Dilution` = case_when(
Dilution == "0" ~  1.0,
TRUE ~ `Dilution`  # leave unchanged if no match
)) %>%
mutate(Conc_dilcorr = Conc * Dilution,
Conc_uM_dilcor = Conc_uM * Dilution)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(samples_flagged_dilcorr$Sample_Name),'_',fixed=TRUE)))
colnames(IDs) <- c("Site_Code" , "Date","Zone", "Lysimeter", "Depth")
head(IDs)
#rejoin them to the dataframe
dat_florplot <- cbind(IDs, samples_flagged_dilcorr)
head(dat_florplot)
#scale_color_manual(values=c("darkgrey","#FFBC42", "#20063B", "#419973"))+
#Plot data and change colors based on flags to check it:
viz_NOx_plot <-  ggplot(data = dat_florplot, aes(x = Grid_Square, y = npoc_raw, fill=Site_Code)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Plot_name, levels=c('Control', 'Freshwater', 'Saltwater'))) +
#  scale_fill_manual(values = c("UP" = "springgreen2", "Freshwater" = "cyan2",
#   "Saltwater" = "violetred2")) +
theme_classic() + labs(x= " ", y="NPOC (mg/L)", title="Carbon by Plot") +
theme(legend.position="none")
viz_NH3_plot <-  ggplot(data = dat_florplot, aes(x = Grid_Square, y = tdn_raw, fill=Plot_name)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Plot_name, levels=c('Control', 'Freshwater', 'Saltwater'))) +
scale_fill_manual(values = c("Control" = "springgreen2", "Freshwater" = "cyan2",
"Saltwater" = "violetred2")) +
theme_classic() + labs(x= " ", y="TN (mg/L)", title="Nitrogen by Plot") +
theme(legend.position="none")
viz_PO4_plot <-  ggplot(data = dat_florplot, aes(x = Grid_Square, y = tdn_raw, fill=Plot_name)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Plot_name, levels=c('Control', 'Freshwater', 'Saltwater'))) +
scale_fill_manual(values = c("Control" = "springgreen2", "Freshwater" = "cyan2",
"Saltwater" = "violetred2")) +
theme_classic() + labs(x= " ", y="TN (mg/L)", title="Nitrogen by Plot") +
theme(legend.position="none")
ggarrange(viz_c_plot, viz_n_plot, nrow=1, ncol=2)
viz_NOx_plot
ggplot(data = dat_florplot, aes(x = Grid_Square, y = npoc_raw, fill=Site_Code)) +
geom_bar(stat = 'identity')
ggplot(data = dat_florplot, aes(x = Zone, y = npoc_raw, fill=Site_Code)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH")))
ggplot(data = dat_florplot, aes(x = Zone, y = Conc, fill=Site_Code)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH")))
ggplot(data = dat_florplot, aes(x = Zone, y = Conc, fill=Site_Code)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"TR" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
ggplot(data = dat_florplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"TR" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
ggplot(data = dat_florplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
View(dat_florplot)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(samples_flagged_dilcorr$Sample_Name),'_',fixed=TRUE)))
colnames(IDs) <- c("Site_Code" , "Date","Zone", "Lysimeter", "Depth")
head(IDs)
#rejoin them to the dataframe
dat_florplot <- cbind(IDs, samples_flagged_dilcorr)
head(dat_florplot)
NOx_forplot <- dat_florplot %>%
filter(str_detect(Test, "Vanadium NOx"))%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
NOx_forplot <- dat_florplot %>%
filter(Test == "Vanadium NOx")%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
names(dat_florplot)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(samples_flagged_dilcorr$Sample_Name),'_',fixed=TRUE)))
colnames(IDs) <- c("Site_Code" , "Date","Zone", "Lysimeter", "Depth", "Excess_Info")
head(IDs)
#rejoin them to the dataframe
dat_florplot <- cbind(IDs, samples_flagged_dilcorr)
head(dat_florplot)
NOx_forplot <- dat_florplot %>%
filter(Test == "Vanadium NOx")%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
NH3_forplot <- dat_florplot %>%
filter(str_detect(Test, "Ammonia 2"))%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
PO4_forplot <- dat_florplot %>%
filter(str_detect(Test, "o-PHOS 0.3"))%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
#Plot data and change colors based on flags to check it:
viz_NOx_plot <-  ggplot(data = NOx_forplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
viz_NH3_plot <- ggplot(data = NH3_forplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
viz_PO4_plot <- ggplot(data = PO4_forplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
ggarrange(viz_NOx_plot, viz_NH3_plot, viz_PO4_plot, nrow=1, ncol=2)
cat("Visualize Data")
#Plot samples to get a first look at concentrations (sanity check)
IDs <- data.frame(do.call('rbind', strsplit(as.character(samples_flagged_dilcorr$Sample_Name),'_',fixed=TRUE)))
colnames(IDs) <- c("Site_Code" , "Date","Zone", "Lysimeter", "Depth", "Excess_Info")
head(IDs)
#rejoin them to the dataframe
dat_florplot <- cbind(IDs, samples_flagged_dilcorr)
head(dat_florplot)
NOx_forplot <- dat_florplot %>%
filter(Test == "Vanadium NOx")%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
NH3_forplot <- dat_florplot %>%
filter(str_detect(Test, "Ammonia 2"))%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
PO4_forplot <- dat_florplot %>%
filter(str_detect(Test, "o-PHOS 0.3"))%>%
mutate(Zone = factor(Zone, levels = c("UP", "SWAMP", "TR", "WC", "SW"))  # your desired order
)
#Plot data and change colors based on flags to check it:
viz_NOx_plot <-  ggplot(data = NOx_forplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NOx (mg/L)", title="NOx by Site and Zone") +
theme(legend.position="none")
viz_NH3_plot <- ggplot(data = NH3_forplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="NH3 (mg/L)", title="NH3 by Site and Zone") +
theme(legend.position="none")
viz_PO4_plot <- ggplot(data = PO4_forplot, aes(x = Zone, y = Conc, fill=Zone)) +
geom_bar(stat = 'identity') +
facet_grid(~factor(Site_Code, levels=c('GCW', 'MSM', 'GWI', "SWH"))) +
scale_fill_manual(values = c("UP" = "#20063B", "TR" = "#FFBC42", "SWAMP" = "darkgrey",
"WC" = "#419973", "SW" = "#25ABE6")) +
theme_classic() + labs(x= " ", y="PO4 (mg/L)", title="PO4 by Site and Zone") +
theme(legend.position="none")
ggarrange(viz_NOx_plot, viz_NH3_plot, viz_PO4_plot, nrow=1, ncol=3)
final_path <- "Processed Data/COMPASS_Synoptic_Nutrients_202304.csv"
#Prepare data to be exported
head(samples_flagged_dilcorr)
#Prepare data to be exported
head(dat_florplot)
#rejoin them to the dataframe
dat_forplot <- cbind(IDs, samples_flagged_dilcorr)
processed_data <- dat_forplot %>%
select(-Excess_Info) %>% #Take out the excess column
mutate(Replicate = str_replace(Lysimeter, "Lys", "")) %>%
mutate(
Depth = if_else(Zone == "SW", 0, Depth)
)
processed_data <- dat_forplot %>%
select(-Excess_Info) %>% #Take out the excess column
mutate(Replicate = str_replace(Lysimeter, "Lys", "")) %>%
mutate(
Depth = if_else(Zone == "SW", "0", Depth)
)
View(processed_data)
processed_data <- dat_forplot %>%
mutate(Replicate = str_replace(Lysimeter, "Lys", ""),
Depth_cm = str_replace(Lysimeter, "cm", "")) %>%
mutate(
Depth = if_else(Zone == "SW", "0", Depth)
)  %>%
select(-Excess_Info, Depth, Lysimeter) #Take out the excess column
processed_data <- dat_forplot %>%
mutate(Replicate = str_replace(Lysimeter, "Lys", ""),
Depth_cm = str_replace(Depth, "cm", "")) %>%
mutate(
Depth = if_else(Zone == "SW", "0", Depth)
)  %>%
select(-Excess_Info, Depth, Lysimeter) #Take out the excess column
processed_data <- dat_forplot %>%
mutate(Replicate = str_replace(Lysimeter, "Lys", ""),
Depth_cm = str_replace(Depth, "cm", "")) %>%
mutate(
Depth_cm = if_else(Zone == "SW", "0", Depth)
)  %>%
select(-Excess_Info, Depth, Lysimeter) #Take out the excess column
processed_data <- dat_forplot %>%
mutate(Replicate = str_replace(Lysimeter, "Lys", ""),
Depth_cm = str_replace(Depth, "cm", "")) %>%
mutate(
Depth_cm = if_else(Zone == "SW", "0", Depth_cm)
)  %>%
select(-Excess_Info, Depth, Lysimeter) #Take out the excess column
processed_data <- dat_forplot %>%
mutate(Replicate = str_replace(Lysimeter, "Lys", ""),
Depth_cm = str_replace(Depth, "cm", "")) %>%
mutate(
Depth_cm = if_else(Zone == "SW", "0", Depth_cm)
)  %>%
select(-c(Excess_Info, Depth, Lysimeter)) #Take out the excess column
sample_year <- 2023
sample_month <- 04
processed_data <- dat_forplot %>%
mutate(Replicate = str_replace(Lysimeter, "Lys", ""),
Depth_cm = str_replace(Depth, "cm", ""),
Year = sample_year,
Month = sample_month) %>%
mutate(
Depth_cm = if_else(Zone == "SW", "0", Depth_cm)
)  %>%
select(-c(Excess_Info, Depth, Lysimeter)) #Take out the excess column
cat("Assess Blanks")
#Pull out check standards from raw file
NOx_blks <- df_all %>%
filter(str_detect(Sample_Name, "CCB"))%>%
mutate(rep = row_number())
NH3_chks <- df_all %>%
filter(Test == "Ammonia 2")%>%
filter(str_detect(Sample_Name, "Blank"))%>%
mutate(rep = row_number())
PO4_chks <- df_all %>%
filter(Test == "o-PHOS 0.3")%>%
filter(str_detect(Sample_Name, "Blank"))%>%
mutate(rep = row_number())
#I think we want to check that the blank concentrations are less than the lowest 25% of sample concentrations:
blk_flag_NOx <- samples %>%
filter(Test == "Vanadium NOx") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
NOx_blks$NOx_diff_flag <-  ifelse(NOx_blks$Conc <= blk_flag_NOx, 'YES', 'NO, rerun')
blk_flag_NH3 <- samples %>%
filter(Test == "Ammonia 2") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
NH3_chks$NH3_diff_flag <-  ifelse(NH3_chks$Conc <= blk_flag_NH3, 'YES', 'NO, rerun')
blk_flag_PO4 <- samples %>%
filter(Test == "o-PHOS 0.3") %>%
summarise(Q1 = quantile(Conc, 0.25))   #this gives you the lower 25% quartile of the data
PO4_chks$PO4_diff_flag <-  ifelse(PO4_chks$Conc <= blk_flag_PO4, 'YES', 'NO, rerun')
#calculate the percent of check standards that are within the range based on the flag
NOx_blks_percent <- (sum(NOx_blks$NOx_diff_flag == "YES")/nrow(NOx_blks))*100
NH3_blks_percent <- (sum(NH3_chks$NH3_diff_flag == "YES")/nrow(NH3_chks))*100
PO4_blks_percent <- (sum(PO4_chks$PO4_diff_flag == "YES")/nrow(PO4_chks))*100
#report out if flags indicate need for rerun
ifelse(NOx_blks_percent >= 60,
">60% of NOx Blank concentrations are lower than the lower 25% quartile of samples - PROCEED",
"<60% of NOx blaks are lower 25% quartile of samples - REASSESS")
ifelse(NH3_blks_percent >= 60,
">60% of NH3 Blank concentrations are lower than the lower 25% quartile of samples - PROCEED",
"<60% of NH3 blaks are lower 25% quartile of samples - REASSESS")
ifelse(PO4_blks_percent >= 60,
">60% of PO4 Blank concentrations are lower than the lower 25% quartile of samples- PROCEED",
"<60% of PO4 blaks are lower 25% quartile of samples - REASSESS")
#now plot the DOC concentrations and the TDN concentrations vs. the expected concentration
#then also make the color the percent difference between the expected and observed concentration
NOx_blks_plot <-  ggplot(data = NOx_blks, aes(x = rep, y = Conc, fill=NOx_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="NPOC  (mg/L)", title="NOx Blanks") +
theme(legend.position="bottom") +  geom_hline(yintercept= as.numeric(blk_flag_NOx), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
NH3_blks_plot <-  ggplot(data = NH3_chks, aes(x = rep, y = Conc, fill=NH3_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="TN  (mg/L)", title="NH3 Blanks") +
theme(legend.position="bottom") +  geom_hline(yintercept=as.numeric(blk_flag_NH3), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
PO4_blks_plot <-  ggplot(data = PO4_chks, aes(x = rep, y = Conc, fill=PO4_diff_flag)) +
geom_bar(stat = 'identity') +
scale_fill_manual(values = c("YES" = "darkblue", "NO, rerun" = "darkgrey")) +
theme_classic() + labs(x= " ", y="TN  (mg/L)", title="PO4 Blanks") +
theme(legend.position="bottom") +  geom_hline(yintercept=as.numeric(blk_flag_PO4), linetype="dashed",
color = "black", linewidth=1)  +
guides(fill=guide_legend(title="Blank Conc <25% Quartile Samples"))
ggarrange(NOx_blks_plot, NH3_blks_plot,PO4_blks_plot, nrow=1, ncol=3)
#find average of run carbon and nitrogen blanks for flagging samples later
blk_avg_NOx <- mean(NOx_blks$Conc)
cat("NOx blanks:")
print(blk_avg_NOx)
blk_avg_NH3 <- mean(NH3_chks$Conc)
cat("NH3 blanks:")
print(blk_flag_NH3)
blk_avg_PO4 <- mean(PO4_chks$Conc)
cat("PO4 blanks:")
print(blk_flag_PO4)
