sep = "_",
into = c("Site", "Samp_Time", "Zone", "Replicate", "Depth"),
remove = FALSE) %>%
mutate(Samp_Time = ym(Samp_Time))
cat("Check Sample IDs with Metadata")
#check to see if all samples are present in the metadata
all_present <- all(samples_flagged$Sample_Name %in% nutr_metadata$NUTR_ID)
if (all_present) {
message("All sample IDs are present in metadata.")
} else {
message("Some sample IDs are missing from metadata.")
# Optional: Which ones are missing?
missing_ids <- setdiff(samples_flagged$Sample_Name, nutr_metadata$NUTR_ID)
print(missing_ids)
}
nutr_metadata_selected <- nutr_metadata %>%
select(NUTR_ID, Year, Month, Day, Depth_cm, Lysimeter, Time..24hr., Time.Zone_EDT.EST,  Field.Notes)
#merge metadata with sample run data
merged_data <- samples_flagged %>%
left_join(nutr_metadata_selected, by = c("Sample_Name" = "NUTR_ID"))
df_all_clean <- merged_data %>%
#filter(str_detect(Sample_Name, "GCW|GWI|MSM|SWH")) %>%
#mutate(Run_Time = lubridate::mdy_hm(Run_Time)) %>%
separate(
col = Sample_Name,
sep = "_",
into = c("Site", "Samp_Time", "Zone", "Replicate", "Depth"),
remove = FALSE) %>%
mutate(Samp_Time = ym(Samp_Time))
############### THIS IS ONLY FOR 2023 when SWAMP was called UP and UPLAND was called UPCON ##############
df_all_clean <- df_all_clean %>%
mutate(
Zone = case_when(
Zone == "UPCON" ~ "UP",
Zone == "UP" ~ "SWAMP",
TRUE ~ `Zone`
))
cat("Visualize Data")
### Nitrite + Nitrate
NOx_forplot <- df_all_clean %>%
filter(Test == "Vanadium NOx")
#group the data for plotting
NOx_forplot <- NOx_forplot %>%
group_by(Site) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
ungroup()
viz_NOx_plot <-  ggplot(data = NOx_forplot, aes(x = factor(row_num), y = Conc, fill=Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single"),
color="black") +
facet_grid(~ Site, scales="free_x") +
scale_fill_manual(values = c("UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6")) +
theme_classic() +
labs(x= " ", y="NOx (mg/L)", title="Porewater NOx") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE)+
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
### Ammonia
NH3_forplot <- df_all_clean %>%
filter(Test == "Ammonia 2")
#group the data for plotting
NH3_forplot <- NH3_forplot %>%
group_by(Site) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
ungroup()
viz_NH3_plot <- ggplot(data = NH3_forplot, aes(x = factor(row_num), y = Conc, fill=Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single"),
color="black") +
facet_grid(~ Site, scales="free_x") +
scale_fill_manual(values = c("UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6")) +
theme_classic() +
labs(x= " ", y="H3 (mg/L)", title="Porewater NH3") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE)+
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
### Phosphate
PO4_forplot <- df_all_clean %>%
filter(Test == "o-PHOS 0.3")
#group the data for plotting
PO4_forplot <- PO4_forplot %>%
group_by(Site) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
ungroup()
viz_PO4_plot <- ggplot(data = PO4_forplot, aes(x = factor(row_num), y = Conc, fill=Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single"),
color="black") +
facet_grid(~ Site, scales="free_x") +
scale_fill_manual(values = c("UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6")) +
theme_classic() +
labs(x= " ", y="PO4 (mg/L)", title="Porewater PO4") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE)+
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
print(viz_NOx_plot)
print(viz_NH3_plot)
print(viz_PO4_plot)
cat("Check Sample IDs with Metadata")
#check to see if all samples are present in the metadata
all_present <- all(samples_flagged$Sample_Name %in% nutr_metadata$NUTR_ID)
if (all_present) {
message("All sample IDs are present in metadata.")
} else {
message("Some sample IDs are missing from metadata.")
# Optional: Which ones are missing?
missing_ids <- setdiff(samples_flagged$Sample_Name, nutr_metadata$NUTR_ID)
print(missing_ids)
}
nutr_metadata_selected <- nutr_metadata %>%
select(NUTR_ID, Year, Month, Day, Depth_cm, Lysimeter, Time..24hr., Time.Zone_EDT.EST,  Field.Notes)
#merge metadata with sample run data
merged_data <- samples_flagged %>%
left_join(nutr_metadata_selected, by = c("Sample_Name" = "NUTR_ID"))
df_all_clean <- merged_data %>%
#filter(str_detect(Sample_Name, "GCW|GWI|MSM|SWH")) %>%
#mutate(Run_Time = lubridate::mdy_hm(Run_Time)) %>%
separate(
col = Sample_Name,
sep = "_",
into = c("Site", "Samp_Time", "Zone", "Replicate", "Depth"),
remove = FALSE) %>%
mutate(Samp_Time = ym(Samp_Time))
############### THIS IS ONLY FOR 2023 when SWAMP was called UP and UPLAND was called UPCON ##############
df_all_clean <- df_all_clean %>%
mutate(
Zone = case_when(
Site == "SWH" & Zone == "UP" ~ "SWAMP",
Site == "SWH" & Zone == "UPCON" ~ "UP",
TRUE ~ `Zone`
))
cat("Visualize Data")
### Nitrite + Nitrate
NOx_forplot <- df_all_clean %>%
filter(Test == "Vanadium NOx")
#group the data for plotting
NOx_forplot <- NOx_forplot %>%
group_by(Site) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
ungroup()
viz_NOx_plot <-  ggplot(data = NOx_forplot, aes(x = factor(row_num), y = Conc, fill=Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single"),
color="black") +
facet_grid(~ Site, scales="free_x") +
scale_fill_manual(values = c("UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6")) +
theme_classic() +
labs(x= " ", y="NOx (mg/L)", title="Porewater NOx") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE)+
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
### Ammonia
NH3_forplot <- df_all_clean %>%
filter(Test == "Ammonia 2")
#group the data for plotting
NH3_forplot <- NH3_forplot %>%
group_by(Site) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
ungroup()
viz_NH3_plot <- ggplot(data = NH3_forplot, aes(x = factor(row_num), y = Conc, fill=Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single"),
color="black") +
facet_grid(~ Site, scales="free_x") +
scale_fill_manual(values = c("UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6")) +
theme_classic() +
labs(x= " ", y="H3 (mg/L)", title="Porewater NH3") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE)+
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
### Phosphate
PO4_forplot <- df_all_clean %>%
filter(Test == "o-PHOS 0.3")
#group the data for plotting
PO4_forplot <- PO4_forplot %>%
group_by(Site) %>%
mutate(row_num = factor(row_number())) %>%  # create row_num as factor per group
ungroup()
viz_PO4_plot <- ggplot(data = PO4_forplot, aes(x = factor(row_num), y = Conc, fill=Zone)) +
geom_bar(stat = "identity", position = position_dodge2(preserve = "single"),
color="black") +
facet_grid(~ Site, scales="free_x") +
scale_fill_manual(values = c("UP" = "#20063B",
"TR" = "#FFBC42",
"SWAMP" = "darkgrey",
"WC" = "#419973",
"SW" = "#25ABE6")) +
theme_classic() +
labs(x= " ", y="PO4 (mg/L)", title="Porewater PO4") +
theme(legend.position = "none") +
scale_x_discrete(drop = TRUE)+
theme(axis.text.x = element_text(angle = 90, hjust = 0.5))
print(viz_NOx_plot)
print(viz_NH3_plot)
print(viz_PO4_plot)
cat("Export Processed Data")
#pivot the data set wider to make it wide format
final_data1 <- df_all_clean %>%
pivot_wider(
id_cols = Sample_Name,
names_from = Test,
values_from = Conc,
names_glue = "{Test}_Conc"
)
final_data2 <- df_all_clean %>%
pivot_wider(
id_cols = Sample_Name,
names_from = Test,
values_from = Conc_uM,
names_glue = "{Test}_Conc_uM"
)
final_data3 <- df_all_clean %>%
pivot_wider(
id_cols = Sample_Name,
names_from = Test,
values_from = Conc_flag,
names_glue = "{Test}_Conc_flag"
)
#take out only the columns we want to merge
df_all_clean_cols <- df_all_clean %>%
select(Sample_Name, Site, Zone, Depth, Depth_cm, Lysimeter,
Year, Month, Day, Time..24hr., Time.Zone_EDT.EST,
NOx_flag, NH3_flag, PO4_flag,
Field.Notes)
df_all_clean_cols_one_row <- df_all_clean_cols %>%
group_by(Sample_Name) %>%
slice(1) %>%  # or use summarise() if you want to aggregate
ungroup()
#merge these together
data_list <- list(df_all_clean_cols_one_row, final_data1, final_data2, final_data3)
final_data4 <- reduce(data_list, full_join, by = c("Sample_Name"))
#Add project information
final_data_labeled <- final_data4 %>%
mutate(
Project = "COMPASS: Synoptic",   # new column with same value on every row
Region = "CB",
Run_notes = run_notes,
Analysis_rundate = print(run_date)# new column with notes about the run
)
#Prepare data to be exported
final_data <- final_data_labeled %>%
rename(
Site = Site,
Sample_ID = Sample_Name,
Time = Time..24hr.,
Time_Zone = Time.Zone_EDT.EST,
Replicate = Lysimeter,
NOx_Conc_mgL = `Vanadium NOx_Conc`,
NOx_Conc_uM = `Vanadium NOx_Conc_uM`,
NOx_Conc_Flag = `Vanadium NOx_Conc_flag`,
NOx_QAQC_Flag = NOx_flag,
NH3_Conc_mgL = `Ammonia 2_Conc`,
NH3_Conc_uM = `Ammonia 2_Conc_uM`,
NH3_Conc_Flag =`Ammonia 2_Conc_flag`,
NH3_QAQC_Flag = NH3_flag,
PO4_Conc_mgL = `o-PHOS 0.3_Conc`,
PO4_Conc_uM = `o-PHOS 0.3_Conc_uM`,
PO4_Conc_Flag =`o-PHOS 0.3_Conc_flag`,
PO4_QAQC_Flag = PO4_flag,
Field_notes = Field.Notes
# add more rename pairs as needed
) %>%
select(Project, Region, Site, Zone, Replicate, Depth_cm,
Sample_ID, Year, Month, Day, Time, Time_Zone,
NOx_Conc_mgL, NOx_Conc_uM, NOx_Conc_Flag, NOx_QAQC_Flag,
NH3_Conc_mgL, NH3_Conc_uM, NH3_Conc_Flag, NH3_QAQC_Flag,
PO4_Conc_mgL, PO4_Conc_uM, PO4_Conc_Flag, PO4_QAQC_Flag,
Analysis_rundate,  Run_notes, Field_notes)
#Write out data frame
write.csv(final_data, final_path)
#let you know which section you are in
cat("Setup")
#a link to the Gitbook or whatever protocol you are using for this analysis
#load/install packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
dplyr,
purrr,
ggplot2,
ggpubr,
tidyr,
tidyverse,
tinytex,
stringr,
readr,
LaTeX,
MacTeX,
tinytex,
broom)
#Coefficients / constants that are needed for calculations
N_mw <- 14.0067    # molecular weight of N
P_mw <- 30.973762  # molecular weight of P
Con1 <- 1000       # conversion factor value
Con2 <- 1000000    # conversion factor value
#Detection limit and top standards for flagging
NOx_dl <- 0.025  #mgL
NH3_dl <- 0.02  #mgL
PO4_dl <- 0.003 #mgL
NOx_top <- 1  #mgL
NH3_top <- 2  #mgL
PO4_top <- 0.3 #mgL
#Check Standard concnetrations
NOx_CCV <- 0.5
NH3_CCV <- 1.0
PO4_CCV <- 0.15
#Spike Concentrations
NOx_Spk <- 0.5 #ppm or mg/L
NH3_Spk <- 1
PO4_Spk <- 0.152
#expected ranges for sample concentrations used for flags
r2_cutoff = 0.990
chk_flag = 0.10
chk_conc_flag = 15 #cutoff level for percent difference of check stds vs. expected concentration
chks_flag = 60
rep_flag = 25
#^this is a 25% error between samples
#blank_flag is calculated based on samples later in this code
cat("Run Information: Input by User") #lets you know what section you're in
#set the run date & user name
run_date <- "20240114"
sample_year <- 2023
sample_month <- 06
user <- "Stephanie Wilson"
#identify the files you want to read in
#read in as a list to accommadate ultiple runs in a month
NOx_files <- c("Raw Data/SEAL_COMPASS_Synoptic_NOx_June2023_1.csv",
"Raw Data/SEAL_COMPASS_Synoptic_NOx_June2023_2.csv",
"Raw Data/SEAL_COMPASS_Synoptic_NOx_June2023_3.csv")
NH3_PO4_files <- c("Raw Data/SEAL_COMPASS_Synoptic_NH3_PO4_June2023_1.csv",
"Raw Data/SEAL_COMPASS_Synoptic_NH3_PO4_June2023_2.csv",
"Raw Data/SEAL_COMPASS_Synoptic_NH3_PO4_June2023_3.csv")
# Define the file path for QAQC log file - NO Need to change just check year
file_path <- "Raw Data/SEAL_COMPASS_Synoptic_QAQC_Log_2023.csv"
final_path <- "Processed Data/COMPASS_Synoptic_Nutrients_202306.csv"
#record any notes about the run or anything other info here:
run_notes <- "There are two sample names we suspect were input incorrectly,
they are listed below and have been checked against metadata. The metadata from Goodwin ans Sweethall samples is not present."
#duplicate sample names to be changed
#list the sample iDs that are messed up and create a list
#with run number as well so that we can change them below
wrong_names <- c("GCW_202304_TR_LysC_45cm", "GCW_202304_TR_LysA_20cm_8",
"GWI_202304_UP_LysA_20cm", "GWI_202304_UP_LysA_20cm")
wrong_nums <- c(20, 16, 46, 44)
correct_names <- c("GCW_202304_TR_LysB_45cm", "GCW_202304_TR_LysA_20cm",
"GWI_202304_UP_LysA_10cm", "GWI_202304_UP_LysA_10cm")
#can't determine from metadata - for now unsure
remove_names <- c("GCW_202304_TR_LysA_20cm", "GCW_202304_TR_LysA_20cm",
"GCW_202304_TR_LysB_20cm_13", "GCW_202304_TR_LysB_20cm_13")
#couldn't tell which onethis is from the metadata, no A_10cm which is what we thought
#marked on the sheet, need to check sample vials in freezer
#to see if we have a A_10cm from GCW_TR to be sure
remove_nums <- c(15, 13, 21, 19 )
#Set up file path for metadata
#downloaded metadata csv - downloaded from Google drive as csv for this year
#https://docs.google.com/spreadsheets/d/1HCAN0_q6y17x0RUXVzID09hVal-RfwWc/edit?usp=sharing&ouid=108994740386869376571&rtpof=true&sd=true
Raw_Metadata = "Raw Data/COMPASS_SynopticCB_PW_SampleLog_2023.csv"
#let you know which section you are in
cat("Setup")
#a link to the Gitbook or whatever protocol you are using for this analysis
#load/install packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
dplyr,
purrr,
ggplot2,
ggpubr,
tidyr,
tidyverse,
tinytex,
stringr,
readr,
LaTeX,
MacTeX,
tinytex,
broom)
#Coefficients / constants that are needed for calculations
N_mw <- 14.0067    # molecular weight of N
P_mw <- 30.973762  # molecular weight of P
Con1 <- 1000       # conversion factor value
Con2 <- 1000000    # conversion factor value
#Detection limit and top standards for flagging
NOx_dl <- 0.025  #mgL
NH3_dl <- 0.02  #mgL
PO4_dl <- 0.003 #mgL
NOx_top <- 1  #mgL
NH3_top <- 2  #mgL
PO4_top <- 0.3 #mgL
#Check Standard concnetrations
NOx_CCV <- 0.5
NH3_CCV <- 1.0
PO4_CCV <- 0.15
#Spike Concentrations
NOx_Spk <- 0.5 #ppm or mg/L
NH3_Spk <- 1
PO4_Spk <- 0.152
#expected ranges for sample concentrations used for flags
r2_cutoff = 0.990
chk_flag = 0.10
chk_conc_flag = 15 #cutoff level for percent difference of check stds vs. expected concentration
chks_flag = 60
rep_flag = 25
#^this is a 25% error between samples
#blank_flag is calculated based on samples later in this code
#read in the raw metadata file
raw_metadata <- read.csv(Raw_Metadata)
#make a new columns in the metadata with important info:
metadata <- raw_metadata %>%
mutate(Depth = paste0(Depth_cm, "cm")) %>%
mutate(LysID = paste0("Lys", Lysimeter)) %>%
mutate(YearMonth = sprintf("%d%02d", Year, Month))  %>%
mutate(Zone = case_when(
`Transect.Location` == "Transition" ~ "TR",
`Transect.Location` == "Wetland"    ~ "WC",
`Transect.Location` == "Upland"     ~ "UP",
`Transect.Location` == "Surface Water" ~ "SW",
TRUE                 ~ `Transect.Location`    # keep original value if no match
))
#Create NUTR IDs from what was collected for comparison later
metadata <- metadata %>%
mutate(NUTR_ID = ifelse(NUTR == "x",
paste(Site,
YearMonth,
Zone,
LysID,
Depth,
sep = "_"),
NA) )
#Change the SW lines because they don't have lysimeters or a depth
metadata <- metadata %>%
mutate(
NUTR_ID = if_else(
Zone == "SW",
# Modify the string:
NUTR_ID %>%
str_replace("_LysA", "_A") %>%                    # Replace "_LysA" with "_A"
str_replace("_LysB", "_B") %>%                    # Replace "_LysB" with "_B"
str_replace("_LysC", "_C") %>%                    # Replace "_LysC" with "_C"
str_replace("_0cm$", ""),                         # Remove trailing "_0cm"
NUTR_ID  # else keep original
)
)
#Take out the columns and rows that are not relevant
nutr_metadata <- metadata %>%
select(NUTR_ID, Year, Month, Day, YearMonth, Site, Zone, Lysimeter, LysID, Depth_cm,
Depth, Time..24hr., Time.Zone_EDT.EST, Field.Notes, ) %>%
# only keep specific columns
filter(!is.na(NUTR_ID) & NUTR_ID != "")  # remove missing/blank NUTR_ID rows
cat("Import Data")
#set file path for data - in run info chunk
path <- ("file path")
#Read in Raw Data
data_NOx <- map(NOx_files, read_csv)
data_NH3_PO4 <- map(NH3_PO4_files, read_csv)
# Combining Files
df_combo <- bind_rows(data_NOx, data_NH3_PO4)
# Rename columns
df_combo_rename <- df_combo %>%
rename('Conc' = ...6,
'Absorbance' = ...7,
'Dilution' = ...9,
'Sample_Name' = ...4,
'Test' = ...13,
'Run_Time' = ...15,
'Unit' = ...12,
'Run_Number' = ...5)
#making list to remove columns
cols_to_remove <- c("RUNSTARTED", "...8", "...10", "...11", "...14")
#Removing columns
df <- df_combo_rename %>%
select(-all_of(cols_to_remove)) %>%
select(!c(1,2))%>%
select(Sample_Name, Run_Number, Conc, Absorbance, Dilution, Unit, Test, Run_Time)
#Checking column headers
head(df)
df <- df %>%
mutate(Run_Number = as.numeric(Run_Number))
# Build a lookup table to check for input error/sample name duplicates
lookup <- tibble(
Sample_Name = wrong_names,
Run_Number = as.numeric(wrong_nums),
Correct_Name = correct_names)
# Join and replace to get correct names into df
df_filtered <- df %>%
left_join(lookup, by = c("Sample_Name", "Run_Number")) %>%
mutate(Sample_Name = coalesce(Correct_Name, Sample_Name)) %>%
select(-Correct_Name)
#also remove any lines that we cannot identify which is the correct one
remove_df <- tibble(
Sample_Name = remove_names,
Run_Number = remove_nums
)
# Remove matching rows
df_all <- df_filtered %>%
anti_join(remove_df, by = c("Sample_Name", "Run_Number"))
# Remove run number column now
df_all <- df_all %>%
select(-Run_Number)
