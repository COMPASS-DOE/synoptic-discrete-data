tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "N",
curve = "TN (mg/L)"
)
#put the together in one dataframe to later add to log
Slopes <- rbind(lm_results_c, lm_results_n)
#store the r2's so they plot on the curve graphs
r2_labels_c <- stds_C %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_C_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_C_ppm))$adj.r.squared, 4),
.groups = "drop"
)
r2_labels_n <- stds_N %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_N_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_N_ppm))$adj.r.squared, 4),
.groups = "drop"
)
##Plot standard Curve or Curves
#C Curve
C_stds_plot <- ggplot(stds_C, aes(x = standard_C_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_c,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "NPOC Std Curve by Date",
x = "Carbon Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
C_stds_plot
#N Curve
N_stds_plot <- ggplot(stds_N, aes(x = standard_N_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "purple") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_n,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "TN Std Curve by Date",
x = "Nitrogen Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
N_stds_plot
#compare slopes to previous runs (from log) in order to assess drift
log <- read.csv(Log_path)
log <- log[ ,-c(1)]
#make sure they both have dates as dates
log$run_date <- as.Date(log$run_date)
Slopes$run_date <- as.Date(Slopes$run_date)
# Filter to only rows in Slopes that are NOT already in log (by run_date + analyte)
new_rows <- anti_join(Slopes, log, by = c("run_date", "analyte"))
cat("Assess the Standard Curves")
#filter standards out of the raw data
stds_all <- raw_allpeaks_name %>%
map_df(read_curve) %>%
filter(grepl("CalCurve", sample_name)) %>%
dplyr::rename(
standard_C_ppm = npoc_raw,
standard_N_ppm = tdn_raw) %>%
select(run_datetime,standard_C_ppm,standard_N_ppm, area) %>%
bind_rows()
#separate by analyte
stds_C <- stds_all %>%
filter(!is.na(standard_C_ppm)) %>%
select(-standard_N_ppm) %>%
mutate(run_date = as.Date(strptime(run_datetime, format = "%m/%d/%Y %I:%M:%S %p")))
stds_N <- stds_all %>%
filter(!is.na(standard_N_ppm)) %>%
select(-standard_C_ppm) %>%
mutate(run_date = as.Date(strptime(run_datetime, format = "%m/%d/%Y %I:%M:%S %p")))
#calculate slope and r2 of cal curves
#npoc curve
lm_results_c <- stds_C %>%
group_by(run_date) %>%
do({
model = lm(area ~ standard_C_ppm, data = .)
tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "C",
curve = "NPOC (mg/L)"
)
#tn curve
lm_results_n <- stds_N %>%
group_by(run_date) %>%
do({
model = lm(area ~ standard_N_ppm, data = .)
tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "N",
curve = "TN (mg/L)"
)
#put the together in one dataframe to later add to log
Slopes <- rbind(lm_results_c, lm_results_n)
#store the r2's so they plot on the curve graphs
r2_labels_c <- stds_C %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_C_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_C_ppm))$adj.r.squared, 4),
.groups = "drop"
)
r2_labels_n <- stds_N %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_N_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_N_ppm))$adj.r.squared, 4),
.groups = "drop"
)
##Plot standard Curve or Curves
#C Curve
C_stds_plot <- ggplot(stds_C, aes(x = standard_C_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_c,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "NPOC Std Curve by Date",
x = "Carbon Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
C_stds_plot
#N Curve
N_stds_plot <- ggplot(stds_N, aes(x = standard_N_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "purple") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_n,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "TN Std Curve by Date",
x = "Nitrogen Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
N_stds_plot
#compare slopes to previous runs (from log) in order to assess drift
log <- read.csv(Log_path)
log <- log[ ,-c(1)]
#make sure they both have dates as dates
log$run_date <- as.Date(log$run_date)
log$analyte <- as.character(log$analyte)
Slopes$run_date <- as.Date(Slopes$run_date)
# Filter to only rows in Slopes that are NOT already in log (by run_date + analyte)
new_rows <- anti_join(Slopes, log, by = c("run_date", "analyte"))
# Append the new, non-duplicate rows to log
log <- bind_rows(log, new_rows)
head(new_rows)
cat("Assess the Standard Curves")
#filter standards out of the raw data
stds_all <- raw_allpeaks_name %>%
map_df(read_curve) %>%
filter(grepl("CalCurve", sample_name)) %>%
dplyr::rename(
standard_C_ppm = npoc_raw,
standard_N_ppm = tdn_raw) %>%
select(run_datetime,standard_C_ppm,standard_N_ppm, area) %>%
bind_rows()
#separate by analyte
stds_C <- stds_all %>%
filter(!is.na(standard_C_ppm)) %>%
select(-standard_N_ppm) %>%
mutate(run_date = as.Date(strptime(run_datetime, format = "%m/%d/%Y %I:%M:%S %p")))
stds_N <- stds_all %>%
filter(!is.na(standard_N_ppm)) %>%
select(-standard_C_ppm) %>%
mutate(run_date = as.Date(strptime(run_datetime, format = "%m/%d/%Y %I:%M:%S %p")))
#calculate slope and r2 of cal curves
#npoc curve
lm_results_c <- stds_C %>%
group_by(run_date) %>%
do({
model = lm(area ~ standard_C_ppm, data = .)
tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "C",
curve = "NPOC (mg/L)"
)
#tn curve
lm_results_n <- stds_N %>%
group_by(run_date) %>%
do({
model = lm(area ~ standard_N_ppm, data = .)
tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "N",
curve = "TN (mg/L)"
)
#put the together in one dataframe to later add to log
Slopes <- rbind(lm_results_c, lm_results_n)
#store the r2's so they plot on the curve graphs
r2_labels_c <- stds_C %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_C_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_C_ppm))$adj.r.squared, 4),
.groups = "drop"
)
r2_labels_n <- stds_N %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_N_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_N_ppm))$adj.r.squared, 4),
.groups = "drop"
)
##Plot standard Curve or Curves
#C Curve
C_stds_plot <- ggplot(stds_C, aes(x = standard_C_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_c,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "NPOC Std Curve by Date",
x = "Carbon Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
C_stds_plot
#N Curve
N_stds_plot <- ggplot(stds_N, aes(x = standard_N_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "purple") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_n,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "TN Std Curve by Date",
x = "Nitrogen Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
N_stds_plot
#compare slopes to previous runs (from log) in order to assess drift
log <- read.csv(Log_path)
log <- log[ ,-c(1)]
#make sure they both have dates as dates
log$run_date <- as.Date(log$run_date)
log$analyte <- as.character(log$analyte)
log$curve <- as.character(log$curve)
Slopes$run_date <- as.Date(Slopes$run_date)
# Filter to only rows in Slopes that are NOT already in log (by run_date + analyte)
new_rows <- anti_join(Slopes, log, by = c("run_date", "analyte"))
# Append the new, non-duplicate rows to log
log <- bind_rows(log, new_rows)
#plot the current slops with teh previous slopes
Slopes_chk <- ggplot(log, aes(run_date, slope, col=curve)) +
geom_point(size=4) +
geom_line() +
theme_bw() + labs(title="Slope Drift Assessment", x="Run Date", y="Slope") +
scale_color_manual(values=c("blue", "purple"))
Slopes_chk
#write out the log file with the added lines for this run
write.csv(log, Log_path)
#Grab the highest r2 that is available for this run
r2_C = max(lm_results_c$r2)
r2_N = max(lm_results_n$r2)
#Write out to the user whether or not the r2 is above the cutoff of 0.98
ifelse(r2_C <= r2_cutoff,
"NPOC Curve r2 is below cutoff! - REASSESS", "NPOC Curve r2 GOOD")
ifelse(r2_N <= r2_cutoff,
"TN Curve r2 is below cutoff! - REASSESS", "TN Curve r2 GOOD")
#write out a flag to the sample dataframe if the r2 is above the cutoff of 0.98
dat_raw <- dat_raw %>%
mutate(
npoc_flag = if (r2_C <= r2_cutoff) {
"NPOC r2 low"
} else {
""
},
tdn_flag = if (r2_N <= r2_cutoff) {
"TN r2 low"
} else {
""
}
)
cat("Assess the Standard Curves")
#filter standards out of the raw data
stds_all <- raw_allpeaks_name %>%
map_df(read_curve) %>%
filter(grepl("CalCurve", sample_name)) %>%
dplyr::rename(
standard_C_ppm = npoc_raw,
standard_N_ppm = tdn_raw) %>%
select(run_datetime,standard_C_ppm,standard_N_ppm, area) %>%
bind_rows()
#separate by analyte
stds_C <- stds_all %>%
filter(!is.na(standard_C_ppm)) %>%
select(-standard_N_ppm) %>%
mutate(run_date = as.Date(strptime(run_datetime, format = "%m/%d/%Y %I:%M:%S %p")))
stds_N <- stds_all %>%
filter(!is.na(standard_N_ppm)) %>%
select(-standard_C_ppm) %>%
mutate(run_date = as.Date(strptime(run_datetime, format = "%m/%d/%Y %I:%M:%S %p")))
#calculate slope and r2 of cal curves
#npoc curve
lm_results_c <- stds_C %>%
group_by(run_date) %>%
do({
model = lm(area ~ standard_C_ppm, data = .)
tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "C",
curve = "NPOC (mg/L)"
)
#tn curve
lm_results_n <- stds_N %>%
group_by(run_date) %>%
do({
model = lm(area ~ standard_N_ppm, data = .)
tidy_model = tidy(model)             # coefficients
glance_model = glance(model)         # model metrics like R²
tibble(
slope = tidy_model$estimate[2],    # coefficient for standard_C_ppm
intercept = tidy_model$estimate[1],
r2 = glance_model$adj.r.squared
)
}) %>%
mutate(
analyte = "N",
curve = "TN (mg/L)"
)
#put the together in one dataframe to later add to log
Slopes <- rbind(lm_results_c, lm_results_n)
#store the r2's so they plot on the curve graphs
r2_labels_c <- stds_C %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_C_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_C_ppm))$adj.r.squared, 4),
.groups = "drop"
)
r2_labels_n <- stds_N %>%
group_by(run_date) %>%
summarise(
x_pos = max(standard_N_ppm, na.rm = TRUE) * 0.8,
y_pos = max(area, na.rm = TRUE),
r_squared = round(summary(lm(area ~ standard_N_ppm))$adj.r.squared, 4),
.groups = "drop"
)
##Plot standard Curve or Curves
#C Curve
C_stds_plot <- ggplot(stds_C, aes(x = standard_C_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_c,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "NPOC Std Curve by Date",
x = "Carbon Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
C_stds_plot
#N Curve
N_stds_plot <- ggplot(stds_N, aes(x = standard_N_ppm, y = area)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE, color = "purple") +
facet_wrap(~ run_date) +
geom_text(
data = r2_labels_n,
aes(x = x_pos, y = y_pos, label = paste0("R² = ", r_squared)),
inherit.aes = FALSE,
hjust = 1, vjust = 1,
size = 4
) +
labs(
title = "TN Std Curve by Date",
x = "Nitrogen Standard Concentration (ppm)",
y = "Peak Area"
) +
theme_bw()
N_stds_plot
#compare slopes to previous runs (from log) in order to assess drift
log <- read.csv(Log_path)
log <- log[ ,-c(1)]
#make sure they both have dates as dates
log$run_date <- as.Date(log$run_date)
log$analyte <- as.character(log$analyte)
log$curve <- as.character(log$curve)
Slopes$run_date <- as.Date(Slopes$run_date)
# Filter to only rows in Slopes that are NOT already in log (by run_date + analyte)
new_rows <- anti_join(Slopes, log, by = c("run_date", "analyte"))
# Append the new, non-duplicate rows to log
log <- bind_rows(log, new_rows)
#plot the current slops with teh previous slopes
Slopes_chk <- ggplot(log, aes(run_date, slope, col=curve)) +
geom_point(size=4) +
geom_line() +
theme_bw() + labs(title="Slope Drift Assessment", x="Run Date", y="Slope") +
scale_color_manual(values=c("blue", "purple"))
Slopes_chk
#write out the log file with the added lines for this run
write.csv(log, Log_path)
#Grab the highest r2 that is available for this run
r2_C = max(lm_results_c$r2)
r2_N = max(lm_results_n$r2)
#Write out to the user whether or not the r2 is above the cutoff of 0.98
ifelse(r2_C <= r2_cutoff,
"NPOC Curve r2 is below cutoff! - REASSESS", "NPOC Curve r2 GOOD")
ifelse(r2_N <= r2_cutoff,
"TN Curve r2 is below cutoff! - REASSESS", "TN Curve r2 GOOD")
#write out a flag to the sample dataframe if the r2 is above the cutoff of 0.98
dat_raw <- dat_raw %>%
mutate(
npoc_flag = if (r2_C <= r2_cutoff) {
"NPOC r2 low"
} else {
""
},
tdn_flag = if (r2_N <= r2_cutoff) {
"TN r2 low"
} else {
""
}
)
